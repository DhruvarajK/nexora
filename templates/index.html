<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nex</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
    
    <link rel="stylesheet" href="static/chat.css">
    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="/static/main.css">
    <link rel="stylesheet" href="/static/mobile.css">
    <link rel="stylesheet" href="static/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/latex.min.js"></script>
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css"
    media="(prefers-color-scheme: light)">

    <!-- Dark theme -->
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
    media="(prefers-color-scheme: dark)">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" onload="window.renderMathInElement = renderMathInElement;"></script>
    <script src="/static/language-server.js"></script>

    <script src="/static/tailwind.js"></script>
   
</head>
<body>
    <div id="container">
        
        <div id="history" class="collapsed">
            <div id="history-spinner" class="spinner"></div>
        </div>
        
        <div id="chat-box">
            <canvas id="CanavaView"></canvas>
            
            <div class="mob-header">
                <div class="nex-l"><svg class="nav-icon" width="27" height="27" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 7L10 0H8L2 7V9H7L6 16H8L14 9L14 7H9Z" fill="currentColor"></path></svg>Nex</div>
                <div class="new-ch-tog" onclick="createNewChat"><svg class="new-ch-tog-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4V4C8.13623 4 7.20435 4 6.46927 4.30448C5.48915 4.71046 4.71046 5.48915 4.30448 6.46927C4 7.20435 4 8.13623 4 10V13.6C4 15.8402 4 16.9603 4.43597 17.816C4.81947 18.5686 5.43139 19.1805 6.18404 19.564C7.03968 20 8.15979 20 10.4 20H14C15.8638 20 16.7956 20 17.5307 19.6955C18.5108 19.2895 19.2895 18.5108 19.6955 17.5307C20 16.7956 20 15.8638 20 14V14" stroke="currentColor" stroke-linecap="square"></path><path d="M12.4393 14.5607L19.5 7.5C20.3284 6.67157 20.3284 5.32843 19.5 4.5C18.6716 3.67157 17.3284 3.67157 16.5 4.5L9.43934 11.5607C9.15804 11.842 9 12.2235 9 12.6213V15H11.3787C11.7765 15 12.158 14.842 12.4393 14.5607Z" stroke="currentColor" stroke-linecap="square"></path></svg></div>

            </div>
            <div id="main-chat">
                <div id="chat-container" style="display:flex; flex-direction:column; align-items:center;">
                    <div id="chat-container-spinner" class="spinner"></div>
                </div>
            </div>
            <div class="sgs-box">
                <div id="suggestions-container" style="display:none;"></div>
            </div>
            <div id="input-area">
                <div class="inco-info"><div class="inner-inco-info"><span></span><span>This conversation is temporary and won’t be saved to your history.</span></div> </div>
                
                <div class="search-dropdown" id="search-dropdown">

                    <div class="search-options">
                        <button class="search-option" data-option="research">
                            <div class="option-icon">
                                <svg version="1.1"  id="Icons" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
                                viewBox="0 0 32 32" xml:space="preserve" style="transform: scale(1.2);">
                           <style type="text/css" >
                               .st0{fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}
                               .st1{fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
                               .st2{fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:5.2066,0;}
                           </style>
                           <path class="st0" d="M21,9L21,9c-1.9,1.2-3,3.4-3,5.6v0c0,3.5,1.3,6.8,3.6,9.4l1.5,1.6c1.1,1.3,0.2,3.3-1.5,3.3H10.5
                               c-1.7,0-2.6-2-1.5-3.3l1.5-1.6c2.3-2.6,3.6-6,3.6-9.4v0c0-2.3-1.1-4.4-3-5.6l0,0H21z"/>
                           <line class="st0" x1="19" y1="1" x2="19" y2="2"/>
                           <line class="st0" x1="13" y1="2" x2="13" y2="3"/>
                           <line class="st0" x1="16" y1="5" x2="16" y2="6"/>
                           <line class="st0" x1="10" y1="25" x2="22" y2="25"/>
                           </svg>
                            </div>
                            <div class="option-content">
                                <div class="option-name">Research</div>
                                <div class="option-description">Search academic papers and research content</div>
                            </div>
                        </button>
                        <button class="search-option" data-option="web">
                            <div class="option-icon">
                                <svg width="20" height="20" viewBox="-0.5 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 11.8201C22 9.84228 21.4135 7.90885 20.3147 6.26436C19.2159 4.61987 17.6542 3.33813 15.8269 2.58126C13.9996 1.82438 11.9889 1.62637 10.0491 2.01223C8.10927 2.39808 6.32748 3.35052 4.92896 4.74904C3.53043 6.14757 2.578 7.92935 2.19214 9.86916C1.80629 11.809 2.00436 13.8197 2.76123 15.6469C3.51811 17.4742 4.79985 19.036 6.44434 20.1348C8.08883 21.2336 10.0222 21.8201 12 21.8201" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M2 11.8201H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 21.8201C10.07 21.8201 8.5 17.3401 8.5 11.8201C8.5 6.30007 10.07 1.82007 12 1.82007C13.93 1.82007 15.5 6.30007 15.5 11.8201" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M18.3691 21.6901C20.3021 21.6901 21.8691 20.1231 21.8691 18.1901C21.8691 16.2571 20.3021 14.6901 18.3691 14.6901C16.4361 14.6901 14.8691 16.2571 14.8691 18.1901C14.8691 20.1231 16.4361 21.6901 18.3691 21.6901Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M22.9998 22.8202L20.8398 20.6702" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="option-content">
                                <div class="option-name">Web Search</div>
                                <div class="option-description">Search the web for general information</div>
                            </div>
                        </button>
                        <button class="search-option" data-option="reason" >
                            <div class="option-icon">
                                <svg width="20px" height="20px" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.656 17.344c-1.016-1.015-1.15-2.75-.313-4.925.325-.825.73-1.617 1.205-2.365L3.582 10l-.033-.054c-.5-.799-.91-1.596-1.206-2.365-.836-2.175-.703-3.91.313-4.926.56-.56 1.364-.86 2.335-.86 1.425 0 3.168.636 4.957 1.756l.053.034.053-.034c1.79-1.12 3.532-1.757 4.957-1.757.972 0 1.776.3 2.335.86 1.014 1.015 1.148 2.752.312 4.926a13.892 13.892 0 0 1-1.206 2.365l-.034.054.034.053c.5.8.91 1.596 1.205 2.365.837 2.175.704 3.911-.311 4.926-.56.56-1.364.861-2.335.861-1.425 0-3.168-.637-4.957-1.757L10 16.415l-.053.033c-1.79 1.12-3.532 1.757-4.957 1.757-.972 0-1.776-.3-2.335-.86zm13.631-4.399c-.187-.488-.429-.988-.71-1.492l-.075-.132-.092.12a22.075 22.075 0 0 1-3.968 3.968l-.12.093.132.074c1.308.734 2.559 1.162 3.556 1.162.563 0 1.006-.138 1.298-.43.3-.3.436-.774.428-1.346-.008-.575-.159-1.264-.449-2.017zm-6.345 1.65l.058.042.058-.042a19.881 19.881 0 0 0 4.551-4.537l.043-.058-.043-.058a20.123 20.123 0 0 0-2.093-2.458 19.732 19.732 0 0 0-2.458-2.08L10 5.364l-.058.042A19.883 19.883 0 0 0 5.39 9.942L5.348 10l.042.059c.631.874 1.332 1.695 2.094 2.457a19.74 19.74 0 0 0 2.458 2.08zm6.366-10.902c-.293-.293-.736-.431-1.298-.431-.998 0-2.248.429-3.556 1.163l-.132.074.12.092a21.938 21.938 0 0 1 3.968 3.968l.092.12.074-.132c.282-.504.524-1.004.711-1.492.29-.753.442-1.442.45-2.017.007-.572-.129-1.045-.429-1.345zM3.712 7.055c.202.514.44 1.013.712 1.493l.074.13.092-.119a21.94 21.94 0 0 1 3.968-3.968l.12-.092-.132-.074C7.238 3.69 5.987 3.262 4.99 3.262c-.563 0-1.006.138-1.298.43-.3.301-.436.774-.428 1.346.007.575.159 1.264.448 2.017zm0 5.89c-.29.753-.44 1.442-.448 2.017-.008.572.127 1.045.428 1.345.293.293.736.431 1.298.431.997 0 2.247-.428 3.556-1.162l.131-.074-.12-.093a21.94 21.94 0 0 1-3.967-3.968l-.093-.12-.074.132a11.712 11.712 0 0 0-.71 1.492z" fill="currentColor" stroke="currentColor" stroke-width=".1"></path><path d="M10.706 11.704A1.843 1.843 0 0 1 8.155 10a1.845 1.845 0 1 1 2.551 1.704z" fill="currentColor" stroke="currentColor" stroke-width=".2"></path></svg>
                            </div>
                            <div class="option-content">
                                <div class="option-name">Deepthink</div>
                                <div class="option-description">Think for general information</div>
                            </div>
                        </button>
                        <button class="search-option" data-option="system" >
                            <div class="option-icon">
                                <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 16C10.6193 16 9.5 17.1193 9.5 18.5C9.5 19.8807 10.6193 21 12 21C13.3807 21 14.5 19.8807 14.5 18.5C14.5 17.1193 13.3807 16 12 16ZM12 16V12M5.5 8C6.88071 8 8 6.88071 8 5.5C8 4.11929 6.88071 3 5.5 3C4.11929 3 3 4.11929 3 5.5C3 6.88071 4.11929 8 5.5 8ZM5.5 8V8.8C5.5 9.92011 5.5 10.4802 5.71799 10.908C5.90973 11.2843 6.21569 11.5903 6.59202 11.782C7.01984 12 7.57989 12 8.7 12H15.3C16.4201 12 16.9802 12 17.408 11.782C17.7843 11.5903 18.0903 11.2843 18.282 10.908C18.5 10.4802 18.5 9.92011 18.5 8.8V8M18.5 8C19.8807 8 21 6.88071 21 5.5C21 4.11929 19.8807 3 18.5 3C17.1193 3 16 4.11929 16 5.5C16 6.88071 17.1193 8 18.5 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            </div>
                            <div class="option-content">
                                <div class="option-name">System</div>
                                <div class="option-description">System access for Intrepting</div>
                            </div>
                        </button>

                        <button class="search-option" data-option="image" >
                            <div class="option-icon">
                                <svg  style="transform: scale(1.2);" width="23px" height="23px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.46814 17.5319C5.62291 19.7154 7.92876 20.5 12 20.5C17.6255 20.5 19.8804 19.002 20.3853 14.3853M4.46814 17.5319C3.77924 16.2292 3.5 14.4288 3.5 12C3.5 5.5 5.5 3.5 12 3.5C18.5 3.5 20.5 5.5 20.5 12C20.5 12.8745 20.4638 13.6676 20.3853 14.3853M4.46814 17.5319L7.58579 14.4142C8.36684 13.6332 9.63317 13.6332 10.4142 14.4142L10.5858 14.5858C11.3668 15.3668 12.6332 15.3668 13.4142 14.5858L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L20.3853 14.3853M10.691 8.846C10.691 9.865 9.864 10.692 8.845 10.692C7.827 10.692 7 9.865 7 8.846C7 7.827 7.827 7 8.845 7C9.864 7 10.691 7.827 10.691 8.846Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>

                            <div class="option-content">
                                <div class="option-name">Image-Gen</div>
                                <div class="option-description">Image Generation</div>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="input-box">
                    <button id="scroll-to-bottom-btn" style="display: none;" class="scroll-to-bottom"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5.70711 9.71069C5.31658 10.1012 5.31658 10.7344 5.70711 11.1249L10.5993 16.0123C11.3805 16.7927 12.6463 16.7924 13.4271 16.0117L18.3174 11.1213C18.708 10.7308 18.708 10.0976 18.3174 9.70708C17.9269 9.31655 17.2937 9.31655 16.9032 9.70708L12.7176 13.8927C12.3271 14.2833 11.6939 14.2832 11.3034 13.8927L7.12132 9.71069C6.7308 9.32016 6.09763 9.32016 5.70711 9.71069Z" fill="currentColor"/></svg>
                    </button>
                   
                    <div id="upload-preview-container" style="display: none;"></div>
                    <div><textarea id="input-msg" rows="1" placeholder="Ask Anything"></textarea></div>
                    <div class="controls-main">
                        <div class="tools-mn">
                            <button id="upload-btn" class="expand-button">
                                <svg width="20" height="20" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg">
                                    <path 
                                      d="M915.744 213v702.744H213v87.842h702.744v702.744h87.842v-702.744h702.744v-87.842h-702.744V213z"
                                      fill="none"
                                      stroke="currentColor"
                                      stroke-width="100"
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                    />
                                  </svg>
                                  
                                
                            </button>
                           
                            <button id="search-btn" class="expand-button expanded"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.31993 13.28H12.4099V20.48C12.4099 21.54 13.7299 22.04 14.4299 21.24L21.9999 12.64C22.6599 11.89 22.1299 10.72 21.1299 10.72H18.0399V3.51997C18.0399 2.45997 16.7199 1.95997 16.0199 2.75997L8.44994 11.36C7.79994 12.11 8.32993 13.28 9.31993 13.28Z" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 4H1.5" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M7.5 20H1.5" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.5 12H1.5" stroke="currentColor" stroke-width="2" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="label">Quick response</span></button>
                            <button id="inco-btn" class="expand-button" onclick="this.classList.toggle('expanded')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 17.5C21 19.433 19.433 21 17.5 21C15.567 21 14 19.433 14 17.5C14 15.567 15.567 14 17.5 14C19.433 14 21 15.567 21 17.5Z" stroke="currentColor" stroke-width="1.8"/><path d="M2 11H14M22 11H18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 11L4.6138 8.54479C5.15947 6.36211 5.43231 5.27077 6.24609 4.63538C7.0057 4.0423 8.03639 4.00282 10 4.00019M20 11L19.3862 8.54479C18.8405 6.36211 18.5677 5.27077 17.7539 4.63538C16.9943 4.0423 15.9636 4.00282 14 4.00019" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M10 17.5C10 19.433 8.433 21 6.5 21C4.567 21 3 19.433 3 17.5C3 15.567 4.567 14 6.5 14C8.433 14 10 15.567 10 17.5Z" stroke="currentColor" stroke-width="1.8"/><path d="M10 17.4999L10.6584 17.1707C11.5029 16.7484 12.4971 16.7484 13.3416 17.1707L14 17.4999" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg><span class="label">Incognito</span></button>
                        </div>
                        <div class="sned-main-btn">
                            <button id="send-btn"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z"></path></svg></button>
                        </div>
                    </div>
                </div>
            </div>
            <input type="file" id="file-input" style="display: none;" accept="image/*,.pdf,.txt,.doc,.docx,.json,.csv" multiple>
        </div>
        <div id="slidingPanel" class="sliding-panel">
            <div class="panel-header">
                <h2>Sources</h2>
                <button id="closePanelBtn" class="close-btn">×</button>
            </div>
            <div class="panel-content" id="panelContent">
                </div>
        </div>
        
    </div>
    <div id="canvas-panel"></div>

    <div id="full-screen-preview-modal">
        <div id="preview-header">
            <div class="prev-btns"><button id="mobile-view-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8.92993 2L8.95993 3.53003C8.97993 4.34003 9.64993 5 10.4599 5H13.4799C14.3099 5 14.9799 4.32 14.9799 3.5V2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 17L15 19L17 21" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 17L22 19L20 21" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13 22H8C4.5 22 3 20 3 17V7C3 4 4.5 2 8 2H16C19.5 2 21 4 21 7V14" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                </svg><span>Mobile</span></button><button id="desktop-view-btn" class="isactive"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 4.34315 3.34315 3 5 3H19C20.6569 3 22 4.34315 22 6V15C22 16.6569 20.6569 18 19 18H13V19H15C15.5523 19 16 19.4477 16 20C16 20.5523 15.5523 21 15 21H9C8.44772 21 8 20.5523 8 20C8 19.4477 8.44772 19 9 19H11V18H5C3.34315 18 2 16.6569 2 15V6ZM5 5C4.44772 5 4 5.44772 4 6V15C4 15.5523 4.44772 16 5 16H19C19.5523 16 20 15.5523 20 15V6C20 5.44772 19.5523 5 19 5H5Z" fill="currentColor"/>
                    </svg> <span>Desktop</span></button></div>
            <span class="tooltip" style="margin-left: auto;">
                <button id="close-preview"><svg width="22" height="22" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M195.2 195.2a64 64 0 0 1 90.496 0L512 421.504 738.304 195.2a64 64 0 0 1 90.496 90.496L602.496 512 828.8 738.304a64 64 0 0 1-90.496 90.496L512 602.496 285.696 828.8a64 64 0 0 1-90.496-90.496L421.504 512 195.2 285.696a64 64 0 0 1 0-90.496z"/></svg></button>
                <span class="tooltip-text">Close Preview</span>
            </span>
        </div>
        <div id="preview-iframe-container">
            <iframe id="preview-iframe" class="desktop-view"></iframe>
        </div>
    </div>


    <div id="images-modal" class="images-modal" aria-hidden="true" role="dialog" aria-labelledby="images-modal-title">
        <div class="images-modal__panel" role="document">
          <div class="img-model-head">
            <div style="display: flex;"><button id="close-modal-btn" class="images-modal__close" aria-label="Close"><span class="desk-close">&times;</span><span class="mob-clos"><svg width="15px" height="15px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.7071 4.29289C12.0976 4.68342 12.0976 5.31658 11.7071 5.70711L6.41421 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H6.41421L11.7071 18.2929C12.0976 18.6834 12.0976 19.3166 11.7071 19.7071C11.3166 20.0976 10.6834 20.0976 10.2929 19.7071L3.29289 12.7071C3.10536 12.5196 3 12.2652 3 12C3 11.7348 3.10536 11.4804 3.29289 11.2929L10.2929 4.29289C10.6834 3.90237 11.3166 3.90237 11.7071 4.29289Z" fill="currentColor"/>
                </svg></span></button></div>
              <div><h2 id="images-modal-title" class="images-modal__title">Gallery</h2></div>
          </div>
      
          <div id="loading-global" class="images-modal__global-loading" aria-live="polite">
            <div class="spinner-img"></div>
          </div>
      
          <div id="no-images-msg" class="images-modal__noimages" hidden>
            <div style="display: flex; align-items:center;justify-content: center;" ><svg   width="43px" height="43px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.46814 17.5319C5.62291 19.7154 7.92876 20.5 12 20.5C17.6255 20.5 19.8804 19.002 20.3853 14.3853M4.46814 17.5319C3.77924 16.2292 3.5 14.4288 3.5 12C3.5 5.5 5.5 3.5 12 3.5C18.5 3.5 20.5 5.5 20.5 12C20.5 12.8745 20.4638 13.6676 20.3853 14.3853M4.46814 17.5319L7.58579 14.4142C8.36684 13.6332 9.63317 13.6332 10.4142 14.4142L10.5858 14.5858C11.3668 15.3668 12.6332 15.3668 13.4142 14.5858L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L20.3853 14.3853M10.691 8.846C10.691 9.865 9.864 10.692 8.845 10.692C7.827 10.692 7 9.865 7 8.846C7 7.827 7.827 7 8.845 7C9.864 7 10.691 7.827 10.691 8.846Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></div> 
            <div>Empty Gallery</div></div>
      
          <div id="images-grid" class="images-grid" aria-live="polite"></div>
        </div>
    </div>

    <div id="files-modal" class="images-modal" aria-hidden="true" role="dialog" aria-labelledby="files-modal-title">
        <div class="images-modal__panel" role="document">
          <div class="img-model-head">
            <div style="display: flex;"><button id="close-files-modal-btn" class="images-modal__close" aria-label="Close"><span class="desk-close">&times;</span><span class="mob-clos"><svg width="15px" height="15px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.7071 4.29289C12.0976 4.68342 12.0976 5.31658 11.7071 5.70711L6.41421 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H6.41421L11.7071 18.2929C12.0976 18.6834 12.0976 19.3166 11.7071 19.7071C11.3166 20.0976 10.6834 20.0976 10.2929 19.7071L3.29289 12.7071C3.10536 12.5196 3 12.2652 3 12C3 11.7348 3.10536 11.4804 3.29289 11.2929L10.2929 4.29289C10.6834 3.90237 11.3166 3.90237 11.7071 4.29289Z" fill="currentColor"/>
                </svg></span></button></div>
              <div><h2 id="files-modal-title" class="images-modal__title">Code Files</h2></div>
          </div>
      
          <div id="loading-files-global" class="images-modal__global-loading" aria-live="polite">
            <div class="spinner-img"></div>
          </div>
      
          <div id="no-files-msg" class="images-modal__noimages" hidden>
            <div style="display: flex; align-items:center;justify-content: center;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2.26953V6.40007C14 6.96012 14 7.24015 14.109 7.45406C14.2049 7.64222 14.3578 7.7952 14.546 7.89108C14.7599 8.00007 15.0399 8.00007 15.6 8.00007H19.7305M14 17.5L16.5 15L14 12.5M10 12.5L7.5 15L10 17.5M20 9.98822V17.2C20 18.8802 20 19.7202 19.673 20.362C19.3854 20.9265 18.9265 21.3854 18.362 21.673C17.7202 22 16.8802 22 15.2 22H8.8C7.11984 22 6.27976 22 5.63803 21.673C5.07354 21.3854 4.6146 20.9265 4.32698 20.362C4 19.7202 4 18.8802 4 17.2V6.8C4 5.11984 4 4.27976 4.32698 3.63803C4.6146 3.07354 5.07354 2.6146 5.63803 2.32698C6.27976 2 7.11984 2 8.8 2H12.0118C12.7455 2 13.1124 2 13.4577 2.08289C13.7638 2.15638 14.0564 2.27759 14.3249 2.44208C14.6276 2.6276 14.887 2.88703 15.4059 3.40589L18.5941 6.59411C19.113 7.11297 19.3724 7.3724 19.5579 7.67515C19.7224 7.94356 19.8436 8.2362 19.9171 8.5423C20 8.88757 20 9.25445 20 9.98822Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div> 
            <div>No Files</div>
          </div>
      
          <div id="files-grid" class="code-grid" aria-live="polite"></div>
        </div>
    </div>

    <div id="agent-modal" class="hidden min-h-screen flex flex-col fixed z-[999] w-[100%]">
        <header class="flex justify-between items-center p-4">
        <button onclick="closeAgentModal()" class="text-2xl text-black dark:text-white">&times;</button>
        <h1 class="text-xl font-bold text-black dark:text-white">Agents</h1>
        <button id="addTaskBtn" onclick="showModal()" class="text-3xl text-black dark:text-white">+</button>
        </header>
      
        <main class="bg-white dark:bg-black flex-grow flex flex-col">
        <div id="emptyStateContainer" class="flex flex-col items-center justify-center text-center p-6 flex-grow hidden">
         <div class="w-16 h-16 bg-gray-200 dark:bg-[#0c0c0c] rounded-full flex items-center justify-center">
           <svg class="w-9 h-9 text-black dark:text-white" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><title>network</title><path stroke-width="1.2" stroke="currentColor" d="M27 22.25c-0.831 0.002-1.598 0.277-2.215 0.739l0.010-0.007-3.299-2.998c0.82-1.097 1.313-2.479 1.313-3.977 0-1.614-0.572-3.094-1.525-4.249l0.009 0.011 3.644-3.643c0.584 0.391 1.302 0.624 2.074 0.624 2.077 0 3.76-1.683 3.76-3.76s-1.683-3.76-3.76-3.76c-2.077 0-3.76 1.683-3.76 3.76 0 0.773 0.233 1.491 0.633 2.088l-0.009-0.014-3.643 3.643c-1.145-0.944-2.627-1.517-4.244-1.517-0.937 0-1.828 0.192-2.638 0.54l0.044-0.017-1.032-1.874c0.791-0.688 1.288-1.695 1.288-2.819 0-2.060-1.67-3.729-3.729-3.729s-3.729 1.67-3.729 3.729c0 2.060 1.67 3.729 3.729 3.729 0.007 0 0.015-0 0.022-0h-0.001c0.398-0.006 0.778-0.073 1.133-0.194l-0.026 0.008 1.037 1.883c-1.757 1.243-2.89 3.265-2.894 5.553v0.001c0.010 0.697 0.125 1.364 0.33 1.99l-0.013-0.047-1.423 0.603c-0.681-0.971-1.795-1.597-3.056-1.597-2.056 0-3.722 1.666-3.722 3.722s1.666 3.722 3.722 3.722c2.056 0 3.722-1.666 3.722-3.722 0-0.264-0.027-0.521-0.079-0.769l0.004 0.024 1.419-0.602c1.167 2.093 3.367 3.485 5.892 3.485 1.73 0 3.308-0.654 4.5-1.728l-0.006 0.005 3.309 3.007c-0.335 0.544-0.535 1.201-0.539 1.906v0.001c0 2.071 1.679 3.75 3.75 3.75s3.75-1.679 3.75-3.75c0-2.071-1.679-3.75-3.75-3.75v0zM7.69 5c0-1.243 1.007-2.25 2.25-2.25s2.25 1.007 2.25 2.25c0 1.243-1.007 2.25-2.25 2.25v0c-1.242-0.002-2.248-1.008-2.25-2.25v-0zM5 22.92c-1.242-0.001-2.248-1.007-2.248-2.249s1.007-2.249 2.249-2.249c1.242 0 2.248 1.006 2.249 2.248v0c-0.002 1.242-1.008 2.248-2.25 2.25h-0zM27 2.75c1.243 0 2.25 1.007 2.25 2.25s-1.007 2.25-2.25 2.25c-1.243 0-2.25-1.007-2.25-2.25v0c0.002-1.242 1.008-2.248 2.25-2.25h0zM10.69 16c0-0 0-0 0-0.001 0-2.932 2.377-5.309 5.309-5.309s5.309 2.377 5.309 5.309c0 2.932-2.377 5.309-5.309 5.309h-0c-2.931-0.003-5.306-2.378-5.31-5.308v-0zM27 28.25c-1.243 0-2.25-1.007-2.25-2.25s1.007-2.25 2.25-2.25c1.243 0 2.25 1.007 2.25 2.25v0c-0.002 1.242-1.008 2.248-2.25 2.25h-0z"></path></svg>
         </div>
         <h2 class="text-[1.3rem] font-semibold mt-6 text-black dark:text-white">Get started by adding an agent</h2>
         <p class="mt-2 max-w-sm text-gray-600 dark:text-gray-400">
            Schedule an agent to automate tasks and receive notifications when they complete.
         </p>
         <button onclick="showModal()" class="mt-8 px-8 py-3 bg-gray-200 dark:bg-[#0c0c0c] text-black dark:text-white font-semibold rounded-full text-lg shadow-sm hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
           + Create Agent
         </button>
        </div>
      
        <div id="agentsContainer" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">
            </div>
        </main>
      </div>
      
      <div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-[999]" role="dialog" aria-modal="true">
       <div class="bg-white dark:bg-[#141414] rounded-xl shadow-2xl max-w-md w-full relative">
       <button onclick="closeMainModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl font-bold focus:outline-none">&times;</button>
       <div class="p-8">
        <h2 class="text-2xl font-semibold mb-8 text-black dark:text-white">Create New Task</h2>
        <form id="agentForm">
          <div class="mb-6">
          <label class="block">
           <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Title</span>
           <input type="text" id="title" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#333] text-black dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-0 focus:border-gray-300 dark:focus:border-none" required />
          </label>
          </div>
          <div class="mb-6">
          <label class="block">
           <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Time (HH:MM)</span>
           <input type="time" id="time" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#333] text-black dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-0 focus:border-gray-300 dark:focus:border-none" required />
          </label>
          </div>
          <div class="mb-6">
          <label class="block">
           <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Frequency</span>
           <select id="frequency" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#333] text-black dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-0 focus:border-gray-300 dark:focus:border-none" required>
             <option value="once">Once</option>
             <option value="daily">Daily</option>
             <option value="weekly">Weekly</option>
             <option value="monthly">Monthly</option>
           </select>
          </label>
          </div>
          <div class="mb-6">
          <label class="block">
           <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Prompt</span>
           <textarea id="prompt" rows="4" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#333] text-black dark:text-white rounded-lg shadow-sm focus:outline-none focus:ring-0 focus:border-gray-300 dark:focus:border-none resize-vertical" required></textarea>
          </label>
          </div>
          <div class="mb-8">
          <label class="relative inline-flex items-center cursor-pointer group">
           <input type="checkbox" id="notification" class="sr-only peer" checked />
           <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white dark:after:bg-black after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black dark:peer-checked:bg-white"></div>
           <span class="ml-4 text-sm font-medium text-gray-900 dark:text-gray-300">Enable Notifications</span>
          </label>
          </div>
          <button type="submit" class="w-full bg-black dark:bg-white text-white dark:text-black py-3 rounded-[20px] hover:bg-gray-800 dark:hover:bg-gray-200 focus:outline-none focus:ring-0 transition-colors duration-200 shadow-sm font-medium">
          Create Task
          </button>
        </form>
       </div>
       </div>
      </div>
    
    <script>
        const userId = {{ current_user.id }};
        const PUBLIC_VAPID_KEY = 'BA9K5QMrDJExEYWOeeqw7MmTrShZmvpQhaMZ8N5cTNzvzXo3Z5QuiLSLVtiKZPRK-44PA2xISIp5pO1nOnwULH8';
    </script>
    
    <Script src="/static/icons.js"></Script>
    <script src="/static/agent.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script type="module">
        import { parseMarkdown } from '/static/script.js';
       
    
        // --- NEW STATE MANAGEMENT ---
        let activeChatId = null;
        let is_private = null ; 
        let streamingBuffer = "";
        let monacoEditor = null; // Variable to hold the Monaco Editor instance

        let currentOpenFile = { id: null, filename: null }; 
        
        // --- DOM ELEMENTS ---
        const historyPanel = document.getElementById('history');
        const chatContainer = document.getElementById('chat-container');
        const input = document.getElementById('input-msg');
        const sendBtn = document.getElementById('send-btn');
        const recContainer = document.createElement('div');
        recContainer.id = 'rec-container';
        const scrollableContainer = document.getElementById('main-chat');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
        
        // Spinner elements
        const historySpinner = document.getElementById('history-spinner');
        const chatContainerSpinner = document.getElementById('chat-container-spinner');
        let selectedSearchOption = null; // null means no search selected
        let isSearchActive = false;
        const searchBtn = document.getElementById('search-btn');
        const searchDropdown = document.getElementById('search-dropdown');
        const searchOptions = document.querySelectorAll('.search-option');


        const defaultPlaceholder = 'Ask Anything';

        // Optional: Add a 'selected' class to visually indicate the active button
        function selectButton(btn) {
        [ searchBtn].forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        }

    
        let parseDebounceTimer = null;
        let pendingParseContent = null;

        function debouncedParse(text, callback, immediate = false) {
            pendingParseContent = text;
            
            if (immediate) {
                clearTimeout(parseDebounceTimer);
                const result = parseMarkdown(text);
                callback(result);
                return;
            }
            
            clearTimeout(parseDebounceTimer);
            parseDebounceTimer = setTimeout(() => {
                const result = parseMarkdown(pendingParseContent);
                callback(result);
                pendingParseContent = null;
            }, 100); // Parse every 100ms during streaming
        }



        function toggleExclusiveButton(clickedButton) {
            untoggleOtherButtons(clickedButton);
            clickedButton.classList.toggle('expanded');
        }
        
        function untoggleOtherButtons(exceptButton) {
            const allToggleButtons = document.querySelectorAll('.controls-main .expand-button');
            allToggleButtons.forEach(button => {
                if (button !== exceptButton && button.id !== 'inco-btn') {
                    button.classList.remove('expanded');
                }
            });
            
            if (exceptButton.id !== 'search-btn' && isSearchActive) {
                deactivateSearch();
            }
        }


        searchBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    untoggleOtherButtons(searchBtn);

                    if (searchBtn.classList.contains('selected')) {
                        searchBtn.classList.remove('selected');
                    } else {
                        selectButton(searchBtn);
                    }
                    
                    // If search is currently active, deactivate it
                    if (isSearchActive) {
                        if (searchDropdown.classList.contains('show')) {
                            searchDropdown.classList.remove('show');
                        } else {
                            openSearchDropdown();
                        }
                    } else {
                        if (searchDropdown.classList.contains('show')) {
                            searchDropdown.classList.remove('show');
                        } else {
                            openSearchDropdown();
                        }
                    }
                    
                });
        searchOptions.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        const optionType = option.dataset.option;
                        
                        // If clicking the same option that's already selected, deactivate
                        if (selectedSearchOption === optionType && isSearchActive) {
                            deactivateSearch();
                        } else {
                            // Activate the selected option
                            activateSearch(optionType);
                        }
                        
                        // Close dropdown
                        closeSearchDropdown();
                    });
                });
        
                // Close dropdown when clicking outside (but don't deactivate search)
                document.addEventListener('click', (e) => {
                    if (!searchDropdown.contains(e.target) && !searchBtn.contains(e.target)) {
                        closeSearchDropdown();
                    }
                });
        
                // Helper functions
                function openSearchDropdown() {
                    searchDropdown.classList.add('show');
                    updateSearchOptionsUI();
                }
        
                function closeSearchDropdown() {
                    searchDropdown.classList.remove('show');
                }
        
                function activateSearch(optionType) {
                    selectedSearchOption = optionType;
                    isSearchActive = true;
                    searchBtn.classList.add('expanded');
                    updateSearchButtonUI();
               
                }
        
                function deactivateSearch() {
                    selectedSearchOption = null;
                    isSearchActive = false;
                    searchBtn.classList.remove('expanded');
                    updateSearchButtonUI();
                
                }
        
                function updateSearchButtonUI() {
                    const label = searchBtn.querySelector('.label');
                    const svg = searchBtn.querySelector('svg');
                    
                    if (isSearchActive && selectedSearchOption === 'research') {
                        label.textContent = 'Research';
                        svg.innerHTML = `${ResearchIcoPath}`;
                        svg.setAttribute('viewBox', '0 0 24 24');
                       // svg.setAttribute('fill', 'none');
                    } else if (isSearchActive && selectedSearchOption === 'web') {
                        label.textContent = 'Search';
                        svg.innerHTML = `${SearchIcoPath}`;
                        svg.setAttribute('viewBox', '-0.5 0 25 25');
                      //  svg.setAttribute('fill', 'none');
                    } else if (isSearchActive && selectedSearchOption === 'reason') {
                        label.textContent = 'Reason';
                        svg.innerHTML = `${ReasonIcoPath}`;
                        svg.setAttribute('viewBox', '-3.5 -2 25 25');
                      //  svg.setAttribute('fill', 'none');
                    }else if (isSearchActive && selectedSearchOption === 'system') {
                        label.textContent = 'System';
                        svg.innerHTML = `${SystemIcoPath}`;
                        svg.setAttribute('viewBox', '-0.5 0 25 25');
                     //   svg.setAttribute('fill', 'none');
                    }else if (isSearchActive && selectedSearchOption === 'image') {
                        label.textContent = 'Image Gen';
                        svg.innerHTML = `${ImageGenIcoPath}`;
                        svg.setAttribute('viewBox', '-0.5 0 25 25');
                      //  svg.setAttribute('fill', 'none');
                    }
                    
                    else {
                        if (!searchBtn.classList.contains('expanded')) {
                            searchBtn.classList.add('expanded');
                        }
                        label.textContent = 'Quick response';
                        svg.innerHTML = `
                            <path d="M9.31993 13.28H12.4099V20.48C12.4099 21.54 13.7299 22.04 14.4299 21.24L21.9999 12.64C22.6599 11.89 22.1299 10.72 21.1299 10.72H18.0399V3.51997C18.0399 2.45997 16.7199 1.95997 16.0199 2.75997L8.44994 11.36C7.79994 12.11 8.32993 13.28 9.31993 13.28Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8.5 4H1.5" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7.5 20H1.5" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4.5 12H1.5" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>`;
                        svg.setAttribute('viewBox', '0 0 24 24');
                     //   svg.setAttribute('fill', 'none');
                    }
                }

                
                function updateIncoButtonVisibility() {
                    const incoBtn = document.getElementById('inco-btn');
                    if (activeChatId) {
                        incoBtn.style.display = 'none';
                    } else {
                        incoBtn.style.display = 'flex'; // or whatever the original display value was
                    }
                }

                function hideIncoButtonIfVisible() {
                    const incoBtn = document.getElementById('inco-btn');
                    if (incoBtn && incoBtn.style.display === 'flex') {
                        incoBtn.style.display = 'none';
                    }
                }
                
        
                function updateSearchOptionsUI() {
                    // Update selected state in dropdown
                    searchOptions.forEach(opt => {
                        if (opt.dataset.option === selectedSearchOption && isSearchActive) {
                            opt.classList.add('selected');
                        } else {
                            opt.classList.remove('selected');
                        }
                    });
                }
        
                function handleImageLoad(imgElement) {
                    const wrapper = imgElement.closest('.custom-image-wrapper');
                    if (wrapper) {
                        wrapper.classList.remove('image-loading');
                        wrapper.classList.add('image-loaded');
                        
                    }
                }
                
                function handleImageError(imgElement) {
                    const wrapper = imgElement.closest('.custom-image-wrapper');
                    if (wrapper) {
                        wrapper.classList.remove('image-loading');
                        wrapper.classList.add('image-error');
                        imgElement.alt = 'Failed to load image';
                        imgElement.style.opacity = '0.5';

                    }
                }
        
                function parseMarkdownUser(text) {
                    const imageRegex = /<up-img>(.*?)<\/up-img>/g;
                    let imagesHTML = '';
                    let match;
                    const attachments = [];
                    let imageCounter = 0;
                  
                    // helpers
                    function basenameFromUrl(url) {
                      try {
                        const u = new URL(url, location.href);
                        return decodeURIComponent(u.pathname.split('/').pop() || u.hostname);
                      } catch (e) {
                        return url;
                      }
                    }
                  
                    function escapeHtml(str) {
                      return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    }
                  
                    // collect all <up-img> urls (handles multiple)
                    while ((match = imageRegex.exec(text)) !== null) {
                      const url = match[1].trim();
                      if (url) attachments.push(url);
                    }
                  
                    // file-type mapping
                    const typeMap = {
                      pdf: { cls: 'file-pdf', label: 'PDF', color: '#d6453b' },
                      doc: { cls: 'file-doc', label: 'DOC', color: '#2b7de9' },
                      docx: { cls: 'file-doc', label: 'DOCX', color: '#2b7de9' },
                      xls: { cls: 'file-xls', label: 'XLS', color: '#1e9a4a' },
                      xlsx: { cls: 'file-xls', label: 'XLSX', color: '#1e9a4a' },
                      ppt: { cls: 'file-ppt', label: 'PPT', color: '#e67e22' },
                      pptx: { cls: 'file-ppt', label: 'PPTX', color: '#e67e22' },
                      txt: { cls: 'file-txt', label: 'TXT', color: '#6c757d' },
                      csv: { cls: 'file-txt', label: 'CSV', color: '#6c757d' }
                    };
                  
                    // build HTML for each attachment
                    attachments.forEach((rawUrl) => {
                      const url = rawUrl.trim();
                      const safeUrl = escapeHtml(url);
                      const safeText = escapeHtml(basenameFromUrl(url));
                      const id = `img-${Date.now()}-${imageCounter++}`;
                      const wrapperId = `wrapper-${id}`;
                  
                      // remove query/hash for extension detection
                      const trimmedUrl = url.split(/[?#]/)[0];
                  
                      // get last extension part (if any)
                      const extMatch = trimmedUrl.match(/\.([^.\/]+)$/);
                      const ext = extMatch ? extMatch[1].toLowerCase() : null;
                  
                      // reliable image check using extension (no leading-dot mismatch)
                      const isImage = !!ext && /^(png|jpe?g|gif|svg|webp|bmp|avif)$/i.test(ext);
                  
                      if (isImage) {
                        // image: no link, same wrapper structure as before
                        imagesHTML += `
                          <div class="custom-image-wrapper image-loading" id="${wrapperId}" data-image-id="${id}">
                            <img class="custom-image-element"
                                 id="${id}"
                                 src="${safeUrl}"
                                 alt="${safeText}"
                                 loading="lazy"
                                 data-wrapper="${wrapperId}">
                          </div>
                        `;
                      } else {
                        // file: clickable card (anchor)
                        const extKey = ext || 'file';
                        const info = typeMap[extKey] || { cls: 'file-generic', label: extKey ? extKey.toUpperCase() : 'FILE', color: '#6c757d' };
                  
                        imagesHTML += `
                          <a class="file-card ${info.cls}" href="${safeUrl}" target="_blank" rel="noopener noreferrer" aria-label="${safeText} (${escapeHtml(info.label)})" style="color: ${escapeHtml(info.color)}">
                            <span class="file-card-icon" aria-hidden="true">
                              <svg viewBox="0 0 48 48" width="32" height="32" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg">
                                <path class="file-shape" d="M10 4h20l8 8v28a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" fill="currentColor"/>
                              </svg>
                            </span>
                            <span class="file-card-info">
                              <span class="file-card-name" style="display:none;">${safeText}</span>
                              <span class="file-card-meta">${escapeHtml(info.label.toUpperCase())}</span>
                            </span>
                          </a>
                        `;
                      }
                    });
                  
                    const cleanedText = text.replace(imageRegex, '').trim();
                    return { cleanedText, imagesHTML };
                  }
                  

                    function setupImageObserver() {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach(function(node) {
                                    if (node.nodeType === 1) { // Element node
                                        // Check if it's an image or contains images
                                        const images = node.classList && node.classList.contains('custom-image-element') 
                                            ? [node] 
                                            : node.querySelectorAll ? node.querySelectorAll('.custom-image-element') : [];
                                        
                                        images.forEach(function(img) {
                                            img.addEventListener('load', function() {
                                                handleImageLoad(img);
                                            });
                                            
                                            img.addEventListener('error', function() {
                                                handleImageError(img);
                                            });
                                        });
                                    }
                                });
                            }
                        });
                    });
                    
                    observer.observe(document.body, { childList: true, subtree: true });
                    return observer;
                }
        
                // Initialize the observer when page loads
                let imageObserver;
                document.addEventListener('DOMContentLoaded', function() {
                    imageObserver = setupImageObserver();
                });
        
                
                
                function safeRenderMath(element) {
                    if (typeof renderMathInElement !== 'undefined') {
                        try {
                            renderMathInElement(element, {
                                delimiters: [
                                    { left: '$$', right: '$$', display: true },
                                    { left: '\\[', right: '\\]', display: true },
                                    { left: '\\(', right: '\\)', display: false },
                                    { left: '$', right: '$', display: false }
                                ],
                                throwOnError: false,
                                strict: false,
                                trust: true,
                                // Force Greek letters to work
                                macros: {
                                    "\\Omega": "\\mathit{\\Omega}",
                                    "\\omega": "\\mathit{\\omega}",
                                    "\\Alpha": "\\mathit{A}",
                                    "\\Beta": "\\mathit{B}",
                                    "\\alpha": "\\alpha",
                                    "\\beta": "\\beta",
                                    "\\gamma": "\\gamma",
                                    "\\delta": "\\delta"
                                }
                            });
                        } catch (error) {
                            console.warn('KaTeX rendering failed:', error);
                        }
                    } else {
                        setTimeout(() => safeRenderMath(element), 100);
                    }
                }
        
        // --- SCROLL HELPER FUNCTIONS ---
        function isAtBottom() {
            const threshold = 10; // Increased threshold for mobile
            return scrollableContainer.scrollTop + scrollableContainer.clientHeight >= 
                   scrollableContainer.scrollHeight - threshold;
        }
        
        function scrollToBottom() {
            scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
        }

    const mobileHistoryToggleCSS = `
    .mobile-history-toggle {
    display: none;
    position: fixed;
    top: 20px;
    left: 12px;
    z-index: 100;
    background: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    justify-content: center;
    align-items: center;
    transition: transform 0.3s ease, left 0.3s ease;
}

    .mobile-history-toggle.active {
        left: calc(100vw - 40px);
    }

    .mobile-history-toggle svg {
        width: 26px;
        height: 26px;
    }

    /* Show only on mobile devices */
    @media (max-width: 768px) {
        .mobile-history-toggle {
            display: flex;
        }
        
        /* Hide the regular toggle button on mobile */
        #history .toggle-history {
            display: none;
        }
        
        /* Ensure history panel covers full screen on mobile when open */
        #history.open {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 99;
            padding-top: 0;
        }
    }


`;

// Add the CSS to the document
function addMobileHistoryToggleCSS() {
    const styleElement = document.createElement('style');
    styleElement.textContent = mobileHistoryToggleCSS;
    document.head.appendChild(styleElement);
}
function isMobileDevice() {
    return window.innerWidth <= 768;
}

    function closeHistoryPanel() {
        const mobileToggleBtn = document.querySelector('.mobile-history-toggle');
        
        if (mobileToggleBtn && window.innerWidth <= 768) {
            mobileToggleBtn.classList.remove('active');
            mobileToggleBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6H20M4 12H14M4 18H9" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
        }
        
        if (historyPanel) {
            historyPanel.classList.remove('open');
            historyPanel.classList.add('collapsed');
        }
    }


    function createNewChat() {
        closeHistoryPanel();
        activeChatId = null;
        is_private =null;
        if(document.getElementById('inco-btn').classList.contains('expanded')){
            document.getElementById('inco-btn').classList.remove('expanded');
        }
        clearChatView();
        renderMainChatView();
        renderRecommendations();
        updateSidebarActiveState();
        scrollToBottomBtn.style.display = 'none';
        updateIncoButtonVisibility();
        
        // Reset input and show recommendations
        input.value = '';
        autoResize();
        handleRecommendationVisibility();
    }
    


    function handleRecommendationVisibility() {
        const inputValue = input.value.trim();
        const hasText = inputValue.length > 0;
        
        if (hasText) {
            recContainer.classList.add('hidden');
        } else {
            recContainer.classList.remove('hidden');
        }
    }

async function loadHistoryPanel() {

        historySpinner.style.display = 'block';
        historyPanel.innerHTML = ''; // Clear previous content

        try {
            const newTglBtn = document.createElement('button');
            newTglBtn.className = 'toggle-history';
            newTglBtn.id = 'toggle-history';

            // Directly embed the SVG as a string using a template literal
            newTglBtn.innerHTML = `<div class="side-panel-ic"><svg class="nav-icon" width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 7L10 0H8L2 7V9H7L6 16H8L14 9L14 7H9Z" fill="currentColor"/></svg></div>`;

            // Add click event listener immediately after creating the button
            newTglBtn.onclick = () => {
                historyPanel.classList.toggle('open');
                historyPanel.classList.toggle('collapsed');
            };

            historyPanel.appendChild(newTglBtn);

            // Add hover functionality for auto-expand
            let hoverTimeout;

            

            historyPanel.addEventListener('mouseenter', () => {
                // Disable hover functionality on mobile
                if (isMobileDevice()) return;
                
                if (historyPanel.classList.contains('collapsed')) {
                    hoverTimeout = setTimeout(() => {
                        historyPanel.classList.remove('collapsed');
                        historyPanel.classList.add('open');
                    }, 300); // 300ms delay before expanding
                }
            });

            historyPanel.addEventListener('mouseleave', () => {
                // Disable hover functionality on mobile
                if (isMobileDevice()) return;
                
                clearTimeout(hoverTimeout);
                // Only auto-collapse if it was auto-expanded (not manually opened)
                if (historyPanel.classList.contains('open') && !historyPanel.hasAttribute('data-manually-opened')) {
                    setTimeout(() => {
                        if (!historyPanel.matches(':hover')) { // Double-check mouse isn't back on panel
                            historyPanel.classList.remove('open');
                            historyPanel.classList.add('collapsed');
                        }
                    }, 500); // 500ms delay before collapsing
                }
            });

            // Track manual opens vs hover opens
            newTglBtn.onclick = () => {
                const wasOpen = historyPanel.classList.contains('open');
                historyPanel.classList.toggle('open');
                historyPanel.classList.toggle('collapsed');
                
                // Mark as manually opened/closed
                if (historyPanel.classList.contains('open')) {
                    historyPanel.setAttribute('data-manually-opened', 'true');
                } else {
                    historyPanel.removeAttribute('data-manually-opened');
                }
            };
            window.addEventListener('resize', () => {
                const mobileToggleBtn = document.querySelector('.mobile-history-toggle');
                
                // Reset toggle button position if switching from mobile to desktop
                if (window.innerWidth > 768) {
                    if (mobileToggleBtn) {
                        mobileToggleBtn.classList.remove('active');
                        mobileToggleBtn.style.display = 'none';
                    }
                    
                    // Ensure history panel is properly reset for desktop
                    if (historyPanel) {
                        historyPanel.classList.remove('open');
                        historyPanel.classList.add('collapsed');
                    }
                } else {
                    if (mobileToggleBtn) {
                        mobileToggleBtn.style.display = 'flex';
                    }
                }
            });


            const userName = "{{ current_user.username }}"; 
            const initial = (userName && userName.trim().charAt(0).toUpperCase()) || 'U';

            const userFooter = document.createElement('div');
            userFooter.className = 'history-user-footer';

            userFooter.innerHTML = `
                <button class="user-avatar-btn" aria-haspopup="true" aria-expanded="false" title="${userName}">
                <span class="user-avatar-initial">${initial}</span>
                <span class="nav-text" style="font-size: 16px; font-weight: 700;font-family: monospace;">${userName}</span>
                </button>
                <div class="user-menu" role="menu" hidden>
                <a href="#" class="user-menu-item" id="settings-link" role="menuitem">Settings</a>
                <a href="/logout" class="user-menu-item" id="logout-link" role="menuitem">Logout</a>
                </div>
            `;

            const UpperTools = document.createElement('div');
            UpperTools.className = 'upper-tools';

            const newChatBtn = document.createElement('div');
            newChatBtn.className = 'new-chat-btn';
            newChatBtn.onclick = createNewChat;
            newChatBtn.innerHTML = ' <div class="side-panel-ic"><svg style="transform: scale(1.1);" class="nav-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="stroke-[2] "><path d="M10 4V4C8.13623 4 7.20435 4 6.46927 4.30448C5.48915 4.71046 4.71046 5.48915 4.30448 6.46927C4 7.20435 4 8.13623 4 10V13.6C4 15.8402 4 16.9603 4.43597 17.816C4.81947 18.5686 5.43139 19.1805 6.18404 19.564C7.03968 20 8.15979 20 10.4 20H14C15.8638 20 16.7956 20 17.5307 19.6955C18.5108 19.2895 19.2895 18.5108 19.6955 17.5307C20 16.7956 20 15.8638 20 14V14" stroke="currentColor" stroke-linecap="square"></path><path d="M12.4393 14.5607L19.5 7.5C20.3284 6.67157 20.3284 5.32843 19.5 4.5C18.6716 3.67157 17.3284 3.67157 16.5 4.5L9.43934 11.5607C9.15804 11.842 9 12.2235 9 12.6213V15H11.3787C11.7765 15 12.158 14.842 12.4393 14.5607Z" stroke="currentColor" stroke-linecap="square"></path></svg><h3  class="nav-text">New chat</h3></div>'; 
            UpperTools.appendChild(newChatBtn);

            const ImgBtn = document.createElement('div');
            ImgBtn.className = 'new-img-btn';
            ImgBtn.innerHTML = '<button class="side-panel-ic" id="view-images-btn"> <svg style="transform: scale(1.1);" class="nav-icon" width="23px" height="23px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.46814 17.5319C5.62291 19.7154 7.92876 20.5 12 20.5C17.6255 20.5 19.8804 19.002 20.3853 14.3853M4.46814 17.5319C3.77924 16.2292 3.5 14.4288 3.5 12C3.5 5.5 5.5 3.5 12 3.5C18.5 3.5 20.5 5.5 20.5 12C20.5 12.8745 20.4638 13.6676 20.3853 14.3853M4.46814 17.5319L7.58579 14.4142C8.36684 13.6332 9.63317 13.6332 10.4142 14.4142L10.5858 14.5858C11.3668 15.3668 12.6332 15.3668 13.4142 14.5858L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L20.3853 14.3853M10.691 8.846C10.691 9.865 9.864 10.692 8.845 10.692C7.827 10.692 7 9.865 7 8.846C7 7.827 7.827 7 8.845 7C9.864 7 10.691 7.827 10.691 8.846Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg><h3 class="nav-text">Gallery</h3></button>'
            UpperTools.appendChild(ImgBtn);

            const FilesBtn = document.createElement('div');
            FilesBtn.className = 'new-img-btn';
            FilesBtn.innerHTML = '<button class="side-panel-ic" id="view-files-btn"><svg class="nav-icon" id="file-ico" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.00002 13C8.34002 13.33 7.79002 13.82 7.38002 14.43C7.15002 14.78 7.15002 15.22 7.38002 15.57C7.79002 16.18 8.34002 16.67 9.00002 17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.21 13C15.87 13.33 16.42 13.82 16.83 14.43C17.06 14.78 17.06 15.22 16.83 15.57C16.42 16.18 15.87 16.67 15.21 17" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.22998 8.01L21.45 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg><h3 class="nav-text">Files</h3></button>';        
            UpperTools.appendChild(FilesBtn);

            const AgentBtn = document.createElement('div');
            AgentBtn.className = 'new-agent-btn';
            AgentBtn.innerHTML = '<button class="side-panel-ic" id="view-agent-btn" onclick="openAgentModal()" > <svg fill="currentColor" class="nav-icon" width="16" height="16" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><title>network</title><path stroke-width=".9" stroke="currentColor" d="M27 22.25c-0.831 0.002-1.598 0.277-2.215 0.739l0.010-0.007-3.299-2.998c0.82-1.097 1.313-2.479 1.313-3.977 0-1.614-0.572-3.094-1.525-4.249l0.009 0.011 3.644-3.643c0.584 0.391 1.302 0.624 2.074 0.624 2.077 0 3.76-1.683 3.76-3.76s-1.683-3.76-3.76-3.76c-2.077 0-3.76 1.683-3.76 3.76 0 0.773 0.233 1.491 0.633 2.088l-0.009-0.014-3.643 3.643c-1.145-0.944-2.627-1.517-4.244-1.517-0.937 0-1.828 0.192-2.638 0.54l0.044-0.017-1.032-1.874c0.791-0.688 1.288-1.695 1.288-2.819 0-2.060-1.67-3.729-3.729-3.729s-3.729 1.67-3.729 3.729c0 2.060 1.67 3.729 3.729 3.729 0.007 0 0.015-0 0.022-0h-0.001c0.398-0.006 0.778-0.073 1.133-0.194l-0.026 0.008 1.037 1.883c-1.757 1.243-2.89 3.265-2.894 5.553v0.001c0.010 0.697 0.125 1.364 0.33 1.99l-0.013-0.047-1.423 0.603c-0.681-0.971-1.795-1.597-3.056-1.597-2.056 0-3.722 1.666-3.722 3.722s1.666 3.722 3.722 3.722c2.056 0 3.722-1.666 3.722-3.722 0-0.264-0.027-0.521-0.079-0.769l0.004 0.024 1.419-0.602c1.167 2.093 3.367 3.485 5.892 3.485 1.73 0 3.308-0.654 4.5-1.728l-0.006 0.005 3.309 3.007c-0.335 0.544-0.535 1.201-0.539 1.906v0.001c0 2.071 1.679 3.75 3.75 3.75s3.75-1.679 3.75-3.75c0-2.071-1.679-3.75-3.75-3.75v0zM7.69 5c0-1.243 1.007-2.25 2.25-2.25s2.25 1.007 2.25 2.25c0 1.243-1.007 2.25-2.25 2.25v0c-1.242-0.002-2.248-1.008-2.25-2.25v-0zM5 22.92c-1.242-0.001-2.248-1.007-2.248-2.249s1.007-2.249 2.249-2.249c1.242 0 2.248 1.006 2.249 2.248v0c-0.002 1.242-1.008 2.248-2.25 2.25h-0zM27 2.75c1.243 0 2.25 1.007 2.25 2.25s-1.007 2.25-2.25 2.25c-1.243 0-2.25-1.007-2.25-2.25v0c0.002-1.242 1.008-2.248 2.25-2.25h0zM10.69 16c0-0 0-0 0-0.001 0-2.932 2.377-5.309 5.309-5.309s5.309 2.377 5.309 5.309c0 2.932-2.377 5.309-5.309 5.309h-0c-2.931-0.003-5.306-2.378-5.31-5.308v-0zM27 28.25c-1.243 0-2.25-1.007-2.25-2.25s1.007-2.25 2.25-2.25c1.243 0 2.25 1.007 2.25 2.25v0c-0.002 1.242-1.008 2.248-2.25 2.25h-0z"></path></svg><h3 class="nav-text">Agent</h3></button>'
            UpperTools.appendChild(AgentBtn);

            const newHisBar = document.createElement('div');

            newHisBar.innerHTML = `<div class="history-search"><svg class="history-search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="text" id="chat-search-input" placeholder="Search chats..." autocomplete="off">
        </div>
    `;
            historyPanel.appendChild(newHisBar);
            historyPanel.appendChild(UpperTools);

            const chatSection = document.createElement('div');
            chatSection.className = 'history-section';
            chatSection.innerHTML = '<div class="side-panel-ic"><svg class="nav-icon" id="hist-ico" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="stroke-[2] "><path d="M4.4999 3L4.4999 8H9.49988M4.4999 7.99645C5.93133 5.3205 8.75302 3.5 11.9999 3.5C16.6943 3.5 20.4999 7.30558 20.4999 12C20.4999 16.6944 16.6943 20.5 11.9999 20.5C7.6438 20.5 4.05303 17.2232 3.55811 13" stroke="currentColor"></path><path d="M15 9L12 12V16" stroke="currentColor"></path></svg><h3 id="hist-ico" class="nav-text">Chats</h3></div><div id="chat-list"></div>';
            historyPanel.appendChild(chatSection);

            historyPanel.appendChild(userFooter);

            const avatarBtn = userFooter.querySelector('.user-avatar-btn');
        const userMenu = userFooter.querySelector('.user-menu');

        // toggle menu
        avatarBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // avoid immediately closing by global click handler
            const expanded = avatarBtn.getAttribute('aria-expanded') === 'true';
            avatarBtn.setAttribute('aria-expanded', String(!expanded));
            if (expanded) {
            userMenu.hidden = true;
            } else {
            userMenu.hidden = false;
            // optional: focus first link for keyboard users
            const firstLink = userMenu.querySelector('.user-menu-item');
            if (firstLink) firstLink.focus();
            }
        });

        // close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!userFooter.contains(e.target)) {
            userMenu.hidden = true;
            avatarBtn.setAttribute('aria-expanded', 'false');
            }
        });

        // close on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
            userMenu.hidden = true;
            avatarBtn.setAttribute('aria-expanded', 'false');
            }
        });

            // Fetch and render both
            await loadUserChats();

        } catch (error) {
            console.error("Failed to load history panel:", error);
            historyPanel.innerHTML = '<p style="color: #ff6b6b; padding: 10px;">Error loading history.</p>';
        } finally {
            historySpinner.style.display = 'none';
        }

    
        

    const existingMobileToggle = document.querySelector('.mobile-history-toggle');
        if (existingMobileToggle) {
            existingMobileToggle.remove();
        }
    addMobileHistoryToggleCSS();

    // Create mobile toggle button
    const mobileToggleBtn = document.createElement('button');
    mobileToggleBtn.className = 'mobile-history-toggle';
    mobileToggleBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 6H20M4 12H14M4 18H9" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;

    // Add click event for mobile toggle
    mobileToggleBtn.onclick = (e) => { e.stopPropagation();
        
        const isOpen = historyPanel.classList.contains('open');
        
        if (isOpen) {
            // Closing
            historyPanel.classList.remove('open');
            historyPanel.classList.add('collapsed');
            mobileToggleBtn.classList.remove('active');
            mobileToggleBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6H20M4 12H14M4 18H9" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
        } else {
            // Opening
            historyPanel.classList.remove('collapsed');
            historyPanel.classList.add('open');
            mobileToggleBtn.classList.add('active');
            mobileToggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="two-arrow-icon" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 17 5-5-5-5"></path><path d="m13 17 5-5-5-5"></path></svg>
            `;
        }
    };

    document.body.appendChild(mobileToggleBtn);

    // Add click outside to close on mobile
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && 
            historyPanel.classList.contains('open') && 
            !historyPanel.contains(e.target) && 
            !mobileToggleBtn.contains(e.target)) {
            
            historyPanel.classList.remove('open');
            historyPanel.classList.add('collapsed');
            mobileToggleBtn.classList.remove('active');
            mobileToggleBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6H20M4 12H14M4 18H9" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
        }
    });
}

        
        // --- CORE CHAT FUNCTIONS ---
        async function loadUserChats() {
            const chatList = document.getElementById('chat-list');
            if (!chatList) return;
          
            const res = await fetch('/chats');
            const chats = await res.json();
            chatList.innerHTML = ''; // Clear previous list
          
            // helper to format timestamp per your rules
            function formatChatTimestamp(isoString) {
              if (!isoString) return '';
              const d = new Date(isoString);
              if (isNaN(d)) return '';
          
              const now = new Date();
          
              // start of current week (Sunday)
              const day = now.getDay(); // 0 = Sunday
              const startOfWeek = new Date(now);
              startOfWeek.setHours(0,0,0,0);
              startOfWeek.setDate(now.getDate() - day);
          
              // same day ?
              const isSameDay = d.getFullYear() === now.getFullYear() &&
                                d.getMonth() === now.getMonth() &&
                                d.getDate() === now.getDate();
          
              if (isSameDay) {
                // show time in 12-hour format (e.g. 3:12 PM)
                return d.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', hour12: true });
              } else if (d >= startOfWeek) {
                // show weekday name (e.g. Sunday, Monday)
                return d.toLocaleDateString(undefined, { weekday: 'long' });
              } else {
                // show short date like "Sep 15"
                return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
              }
            }
          
            if (chats.length > 0) {
              chats.forEach(chat => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chat-list-wrapper';
          
                const div = document.createElement('div');
                div.className = 'chat-list-item';
                div.dataset.chatId = chat.id;
                div.onclick = () => selectChat(chat.id);
          
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.flexDirection = 'column';
                left.style.gap = '2px';
                const chatdelta = document.createElement('div');
                chatdelta.className='chat-delta';
                const titleDiv = document.createElement('div');
                titleDiv.textContent = chat.title || 'Untitled';
                titleDiv.className = 'chat-list-title';
          
                left.appendChild(titleDiv);
          
                chatdelta.appendChild(left)
          
                // Right side: timestamp + menu
                const right = document.createElement('div');
                right.style.display = 'flex';
                right.style.alignItems = 'center';
                right.style.gap = '8px';
                right.style.fontSize = '11px';
                const timeSpan = document.createElement('span');
                timeSpan.className = 'chat-list-timestamp';
                timeSpan.textContent = formatChatTimestamp(chat.created_at);
                // store raw timestamp if needed later
                timeSpan.dataset.iso = chat.created_at || '';
          
                right.appendChild(timeSpan);
          
                const menuWrapper = document.createElement('div');
                menuWrapper.className = 'chat-menu-wrapper';
          
                const menuBtn = document.createElement('button');
                menuBtn.className = 'chat-menu-btn';
                menuBtn.onclick = (e) => {
                  e.stopPropagation();
                  toggleMenu(chat.id);
                };
                menuBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24"><path d="M13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6C12.5523 6 13 5.55228 13 5Z" stroke="currentColor"/><path d="M13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13C12.5523 13 13 12.5523 13 12Z" stroke="currentColor"/><path d="M13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19Z" stroke="currentColor"/></svg>`;
          
                menuWrapper.appendChild(menuBtn);
                
          
                // menu (hidden by default)
                const menu = document.createElement('div');
                menu.className = 'chat-menu';
                menu.dataset.chatId = chat.id;
                menu.innerHTML = `<div onclick="renameChat(${chat.id})">Rename</div><div onclick="deleteChat(${chat.id})">Delete</div>`;
          
                chatdelta.appendChild(right)
                div.appendChild(chatdelta);
                div.appendChild(menuWrapper);
                wrapper.appendChild(div);
                wrapper.appendChild(menu);
          
                chatList.appendChild(wrapper);
              });
          
              if (activeChatId === null) {
                clearChatView();
                renderMainChatView();
                renderRecommendations();
              }
            } else {
              if (activeChatId === null) {
                clearChatView();
                renderMainChatView();
                renderRecommendations();
              }
            }
          
            updateSidebarActiveState();

            setupChatSearch();
        }

        function setupChatSearch() {
            const searchInput = document.getElementById('chat-search-input');
            if (!searchInput) return;
        
            let searchTimeout = null;
        
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // Debounce search by 300ms
                searchTimeout = setTimeout(() => {
                    filterChats(searchTerm);
                }, 300);
            });
        
            // Optional: Clear search on ESC key
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    filterChats('');
                }
            });

            
        }
        
        function filterChats(searchTerm) {
            const chatItems = document.querySelectorAll('.chat-list-item');
            let visibleCount = 0;
        
            chatItems.forEach(item => {
                const titleElement = item.querySelector('.chat-list-title');
                const title = titleElement ? titleElement.textContent.toLowerCase() : '';
                
                if (searchTerm === '' || title.includes(searchTerm)) {
                    item.classList.remove('hidden-by-search');
                    visibleCount++;
                } else {
                    item.classList.add('hidden-by-search');
                }
            });
        
            // Optional: Show "no results" message
            const chatList = document.getElementById('chat-list');
            let noResultsMsg = chatList.querySelector('.no-search-results');
            
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-search-results';
                    noResultsMsg.style.padding = '20px';
                    noResultsMsg.style.textAlign = 'center';
                    noResultsMsg.style.color = '#999';
                    noResultsMsg.style.fontSize = '14px';
                    noResultsMsg.textContent = 'No chats found';
                    chatList.appendChild(noResultsMsg);
                }
            } else if (noResultsMsg) {
                noResultsMsg.remove();
            }
        }
          

        
        
        
        function selectChat(chatId) {
            if (activeChatId === chatId) return;
            activeChatId = chatId;
            updateSidebarActiveState();
            loadChatHistory(chatId);
            closeHistoryPanel();
            if(document.getElementById('inco-btn').classList.contains('expanded')){
                document.getElementById('inco-btn').classList.remove('expanded');
            }
            updateIncoButtonVisibility();
        }
        
        async function loadChatHistory(chatId) {
            clearChatView();
            
            // Show spinner and add loading class
            chatContainerSpinner.style.display = 'block';
            chatContainer.classList.add('chat-container-loading');
            
            try {
                const res = await fetch(`/chats/${chatId}/history`);
                const history = await res.json();
                
                if (history.length > 0) {
                    // Hide spinner before adding messages
                    chatContainerSpinner.style.display = 'none';
                    chatContainer.classList.remove('chat-container-loading');
                    
                    history.forEach(item => {
                        appendMessageToChat(item.user, 'user');
                        appendMessageToChat(item.bot, 'bot');
                    });
                } else {
                    // Hide spinner before showing recommendations
                    chatContainerSpinner.style.display = 'none';
                    chatContainer.classList.remove('chat-container-loading');
                    renderRecommendations();
                }
            } catch (error) {
                console.error("Failed to load chat history:", error);
                chatContainerSpinner.style.display = 'none';
                chatContainer.classList.remove('chat-container-loading');
            }
            
            scrollToBottom();
        }

        
        
        async function sendMessage() {
            let msg = input.value.trim();
            if (!msg) return; // Don't create chat for empty messages
            if (!msg && uploadedFiles.length === 0) return;
        
            let currentChatId = activeChatId;
            hideIncoButtonIfVisible();
            if (uploadedFiles.length > 0) {
                const files = uploadedFiles.map(file => ({
                    filename: file.filename,
                    type: file.type,
                    size: file.size,
                    url: file.url,
                    data: file.data
                }));
        
                let imageLinks = "";
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    imageLinks += `<up-img>${file.url}</up-img>\n`;
                }
        
                if (msg) {
                    msg = imageLinks + msg;
                } else {
                    msg = imageLinks.trim();
                }
            }
        
            if (!currentChatId) {
                try {
                    const bodyData = { message: msg };
                    if (document.getElementById('inco-btn').classList.contains('expanded')) {
                        bodyData.is_private = 1;
                    }
        
                    const res = await fetch('/chats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(bodyData),
                    });
        
                    if (!res.ok) throw new Error(`Server error: ${res.status}`);
        
                    const newChat = await res.json();
                    currentChatId = newChat.id;
                    activeChatId = newChat.id;
                    // Don't reload chats yet - wait until message is successfully sent
                } catch (error) {
                    console.error("Failed to create new chat:", error);
                    alert("Could not start a new chat. Please try again.");
                    return;
                }
            }
        
            const requestBody = {
                message: msg,
                chat_id: currentChatId
            };
        

        
            input.value = '';
            autoResize();
            clearRecommendations();
            clearUploadedFiles();
        
            appendMessageToChat(msg, 'user');
            if (uploadedFiles.length > 0) {
                // You can add visual indication of files in the message
            }
        
            const isPrivate = document.getElementById('inco-btn').classList.contains('expanded');
            if (isPrivate) {
                is_private = 1;
           
            }
        
            // Determine status text based on selected mode
            const isSearching = isSearchActive;
            let endpoint = '/chat';
            let statusText = 'typing...';
            if (isSearching && selectedSearchOption === 'web') {
                endpoint = '/search-chat';
                statusText = 'Searching...';
            } else if (isSearching && selectedSearchOption === 'research') {
                endpoint = '/research-chat';
                statusText = 'Researching...';
            } else if (isSearching && selectedSearchOption === 'reason') {
                endpoint = '/reasonchat';
                statusText = 'Thinking...';
            } else if (isSearching && selectedSearchOption === 'system') {
                endpoint = '/exec-chat';
                statusText = 'Analyzing...';
            } else if (isSearching && selectedSearchOption === 'image') {
                endpoint = '/generate-image';
                statusText = 'Generating...';
            }
        
            // --- Status sequences (expanded realistic sequences) ---
            const statusSequences = {
                '/search-chat': [
                    'Searching...',
                    'Scanning results...',
                    'Analyzing relevance...',
                    'Filtering duplicates...',
                    'Checking sources...',
                    'Almost done...'
                ],
                '/research-chat': [
                    'Researching...',
                    'Gathering references...',
                    'Fetching papers and articles...',
                    'Validating facts...',
                    'Summarizing findings...',
                    'Compiling report...',
                    'Almost done...'
                ],
                '/reasonchat': [
                    'Thinking...',
                    'Evaluating options...',
                    'Weighing pros and cons...',
                    'Checking assumptions...',
                    'Testing edge cases...',
                    'Forming conclusion...',
                    'Finalizing answer...'
                ],
                '/exec-chat': [
                    'Analyzing...',
                    'Executing code...',
                    'Parsing input...',
                    'Running checks...',
                    'Compiling results...',
                    'Finalizing output...',
                    'Almost done...'
                ],
        
                '/generate-image': [
                    'Generating...',
                    'Processing image...',
                    'Refining composition...',
                    'Enhancing details...',
                    'Applying styles/effects...',
                    'Optimizing resolution...',
                    'Final touches...'
                ],
                '/chat': [
                    'Typing...',
                ]
            };
        
            // Append placeholder bot bubble (keeps existing inner HTML structure so animations keep working)
            appendMessageToChat('', 'bot', statusText);
        
            // Find the last bot bubble we just appended and mark it so we can safely remove it on error
            const botBubbles = chatContainer.querySelectorAll('.bubble-bot');
            const statusBubble = botBubbles[botBubbles.length - 1];
            if (statusBubble) {
                statusBubble.dataset.statusBubble = '1';
            }
        
            // Grab the element inside the bubble that contains the animated text (.gradient-text) and update only that
            const statusTextEl = statusBubble ? statusBubble.querySelector('.gradient-text') : null;
        
            // Status cycle control variables
            let statusTimerId = null;
            let statusStopped = false;
        
            function stopStatusCycle() {
                statusStopped = true;
                if (statusTimerId) {
                    clearTimeout(statusTimerId);
                    statusTimerId = null;
                }
            }
        
            // Modified startStatusCycle: advance *once* through sequence and stop at the final item.
            function startStatusCycle(textElement, seq, initial) {
                if (!textElement || !Array.isArray(seq) || seq.length === 0) return;
        
                // Show initial or first sequence item
                textElement.innerHTML = initial || seq[0];
        
                // Determine index of the currently displayed item in the sequence
                let i = seq.indexOf(textElement.innerHTML);
                if (i === -1) {
                    i = 0;
                }
        
                // If already at the last item, don't schedule any further updates.
                if (i >= seq.length - 1) {
                    return;
                }
        
                function step() {
                    if (statusStopped) return;
        
                    // If already at final element, stop (do not loop)
                    if (i >= seq.length - 1) {
                        statusTimerId = null;
                        return;
                    }
        
                    i++;
                    textElement.innerHTML = seq[i];
        
                    // If we've reached the last item, don't schedule another step
                    if (i >= seq.length - 1) {
                        statusTimerId = null;
                        return;
                    }
        
                    // otherwise schedule next change (random delay)
                    const delay = 1200 + Math.floor(Math.random() * 1800);
                    statusTimerId = setTimeout(step, delay);
                }
        
                // first change slightly delayed so it doesn't seem instant
                const firstDelay = 1000 + Math.floor(Math.random() * 800);
                statusTimerId = setTimeout(step, firstDelay);
            }
        
            // Start cycling realistic status messages (fall back to '/chat' sequence if endpoint missing)
            const seq = statusSequences[endpoint] || statusSequences['/chat'];
            startStatusCycle(statusTextEl, seq, statusText);
        
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
        
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
        
                const reader = res.body.getReader();
                const dec = new TextDecoder('utf-8');
                let buf = '';
                streamingBuffer = "";
        
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buf += dec.decode(value, { stream: true });
                    const parts = buf.split('\n\n');
                    buf = parts.pop();
                    for (const part of parts) {
                        if (part.includes('data:')) {
                            const [eLine, dLine] = part.split('\n');
                            const eventType = eLine.replace('event: ', '').trim();
                            if (eventType === 'bot') {
                                // stop fake status cycle when the first real bot chunk arrives
                                stopStatusCycle();
                                if (statusBubble) {
                                    // unflag the bubble so we won't accidentally remove it later
                                    delete statusBubble.dataset.statusBubble;
                                }
                                try {
                                    const chunk = JSON.parse(dLine.replace('data: ', ''));
                                    updateBotChunk(chunk);
                                } catch (e) {
                                    console.error("Failed to parse stream chunk:", dLine);
                                }
                            }
                        }
                    }
                }
        
                // ensure cycle is stopped when streaming finishes (in case there were no 'bot' events)
                stopStatusCycle();
        
                finalizeStreamingMessage();
        
                // Only reload chats after successful message exchange
                if (activeChatId && !document.querySelector(`.chat-list-item[data-chat-id="${activeChatId}"]`)) {
                    await loadHistoryPanel();
                }
        
            } catch (error) {
                console.error("Failed to send message:", error);
        
                // stop cycling and remove the placeholder status bubble we appended earlier (safely)
                stopStatusCycle();
                const placeholder = chatContainer.querySelector('.bubble-bot[data-status-bubble="1"]');
                if (placeholder) placeholder.remove();
        
                alert("Failed to send message. Please try again.");
            }
        }
        

        
        function clearUploadedFiles() {
            uploadedFiles = [];
            uploadPreviewContainer.innerHTML = '';
            uploadPreviewContainer.style.display = 'none';
        }
        
        // --- UI & RENDERING HELPERS ---
        function clearChatView() {
            chatContainer.innerHTML = '';
            streamingBuffer = "";
            if (recContainer.parentNode) {
                recContainer.parentNode.removeChild(recContainer);
            }
            recContainer.innerHTML = '';
            const existingSpinner = document.getElementById('chat-container-spinner');
            if (existingSpinner && existingSpinner.parentNode === chatContainer) {
                chatContainer.removeChild(existingSpinner);
            }
            chatContainer.appendChild(chatContainerSpinner);
            chatContainer.offsetHeight;
        }
        function checkScrollButtonVisibility() {
            const hasOverflow = scrollableContainer.scrollHeight > scrollableContainer.clientHeight;
            const isNearBottom = isAtBottom();
            
            if (hasOverflow && !isNearBottom) {
                scrollToBottomBtn.style.display = 'flex';
            } else {
                scrollToBottomBtn.style.display = 'none';
            }
        }

        
        function appendMessageToChat(text, role, status = '') {
            clearRecommendations();
            const bubble = document.createElement('div');
            bubble.className = `bubble bubble-${role}`;
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
        
            if (role === 'bot' && text === '') {
                messageContent.innerHTML = `<div class="status-container">
                    <div class="gradient-text">
                        ${status}
                    </div>
                </div>`;
            } else {
                messageContent.innerHTML = parseMarkdown(text);
                safeRenderMath(messageContent);  // Use your safe function
        
                if (role === 'bot') {
                    applyPostProcessing(messageContent);
                    // Add buttons for bot messages (unchanged behavior)
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'message-buttons bot-buttons';
                    buttonContainer.innerHTML = `
                    <div class="action-buttons h-8 mt-0.5 flex flex-row flex-wrap w-full justify-between last-response print:hidden">
                    <div class="flex items-center w-max rounded-lg text-xs start-0 md:start-3 -ml-4 -mt-2 opacity-100 p-0 gap-0" style="bottom: 120px;">
                    <div class="tooltip">
                            <button class="copy-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Copy" data-state="closed"><span style="opacity: 1; transform: none;">
                            ${CopyIcon}</span>
                            </button>
                            <span class="tooltip-text">Copy</span>
                    </div>
                    <div class="tooltip">
                        <button class="like-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Like" id="radix-«r1oc»" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span style="opacity: 1; transform: none;">
                        ${Like}</span>
                        </button>
                        <span class="tooltip-text">Like</span>
                    </div>                 
                    <div class="tooltip">
                            <button class="dislike-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Dislike" id="radix-«r1oi»" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span style="opacity: 1; transform: none;">
                            ${Dislike}</span>
                            </button>
                            
                        <span class="tooltip-text">Dislike</span>
                    </div> 
                    <div class="tooltip">
                            <button class="regen-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Regenerate" data-state="closed"><span style="opacity: 1; transform: none;">
                            ${ReGen}</span>
                            </button>
                        <span class="tooltip-text">Regerate</span>
                    </div>
                    <div class="tooltip">
                            <button class="export-pdf-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60 relative" type="button" aria-label="Start thread" data-state="closed"><span style="opacity: 1; transform: none;">
                                    ${ExpIco}</span>
                            </button>       
                        <span class="tooltip-text">Export</span>
                    </div>
                        </div>
                    </div>
                    `;
                    bubble.appendChild(buttonContainer);
                } else { // user
                    const { cleanedText, imagesHTML } = parseMarkdownUser(text);
                    messageContent.innerText = "";
                    if (imagesHTML) {
                        bubble.classList.add('has-images');
                        messageContent.classList.add('has-images');
        
                        const imagesContainer = document.createElement('div');
                        imagesContainer.className = 'message-images';
                        imagesContainer.innerHTML = imagesHTML;
                        messageContent.appendChild(imagesContainer);
        
                        const textContainer = document.createElement('div');
                        textContainer.className = 'message-text';
                        const textNode = document.createTextNode(cleanedText);
                        textContainer.appendChild(textNode);
                        messageContent.appendChild(textContainer);
                    } else {
                        const textNode = document.createTextNode(cleanedText);
                        messageContent.appendChild(textNode);
                    }
        
                    // Only one copy button for user bubble
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'message-buttons user-buttons';
                    buttonContainer.innerHTML = `
                        <div class="tooltip">
                            <button class="copy-btn">${CopyIcon}</button>
                            <span class="tooltip-text">Copy Message</span>
                        </div>
                    `;
                    bubble.appendChild(buttonContainer);
                }
            }
        
            bubble.appendChild(messageContent);
            chatContainer.appendChild(bubble);
        
            // Add event listeners for buttons
            if (role === 'bot' && text !== '') {
                const likeBtn = bubble.querySelector('.like-btn');
                const dislikeBtn = bubble.querySelector('.dislike-btn');
                const copyBtn = bubble.querySelector('.copy-btn');
                const exportBtn = bubble.querySelector('.export-pdf-btn');
                likeBtn.onclick = () => handleFeedback(bubble, 'like');
                dislikeBtn.onclick = () => handleFeedback(bubble, 'dislike');
                copyBtn.onclick = (e) => { e.stopPropagation(); copyMessage(bubble); };
                exportBtn.onclick = () => exportToPDF(bubble, text);
            } else if (role === 'user') {
                const copyBtn = bubble.querySelector('.copy-btn');
        
                // Ensure the copy button doesn't cause the bubble click handler to toggle.
                copyBtn.onclick = (e) => { e.stopPropagation(); copyMessage(bubble); };
        
                // Detect touch/hover capability. Use media query fallback for common breakpoints.
                const isTouchDevice = window.matchMedia('(hover: none) and (pointer: coarse)').matches || window.innerWidth <= 768;
        
                if (!isTouchDevice) {
                    // Desktop: show copy button on hover
                    bubble.addEventListener('mouseenter', () => bubble.classList.add('hovered'));
                    bubble.addEventListener('mouseleave', () => bubble.classList.remove('hovered'));
                } else {
                    // Mobile / touch: toggle slide-down copy area on tap
                    bubble.addEventListener('click', (e) => {
                        // ignore clicks on the button itself (we already stopped propagation on copyBtn)
                        // collapse other expanded bubbles
                        const others = document.querySelectorAll('.bubble-user.expanded');
                        others.forEach(b => { if (b !== bubble) b.classList.remove('expanded'); });
        
                        bubble.classList.toggle('expanded');
                    });
                }
            }
        
            scrollToBottom();
            setTimeout(checkScrollButtonVisibility, 100);
        }
        

        function finalizeStreamingMessage() {
            // Clear any pending debounced parses
            clearTimeout(parseDebounceTimer);
            
            const botBubbles = chatContainer.querySelectorAll('.bubble-bot');
            const lastBotBubble = botBubbles[botBubbles.length - 1];
            
            if (lastBotBubble) {
                const messageContent = lastBotBubble.querySelector('.message-content');
                if (messageContent) {
                    debouncedParse(streamingBuffer, (parsedHTML) => {
                        messageContent.innerHTML = parsedHTML;
                        safeRenderMath(messageContent);  // Use your safe function
                        applyPostProcessing(messageContent);
                    }, true);
                }
            }
        }

        const notificationDiv = document.createElement('div');
        notificationDiv.id = 'custom-notification';
        document.body.appendChild(notificationDiv);
        // Function to show notification
        function showNotification(message, isSuccess = true) {
            notificationDiv.textContent = message;
            notificationDiv.style.opacity = '1';
            notificationDiv.style.visibility = 'visible';
            notificationDiv.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                notificationDiv.style.opacity = '0';
                notificationDiv.style.visibility = 'hidden';
                notificationDiv.style.transform = 'translateX(-50%) translateY(-100%)';
            }, 2000); // Unified timeout of 2000ms for both success and error
        }
        
        function updateBotChunk(chunk) {
            streamingBuffer += chunk;
            const botBubbles = chatContainer.querySelectorAll('.bubble-bot');
            const lastBotBubble = botBubbles[botBubbles.length - 1];
            
            if (lastBotBubble) {
                const wasAtBottom = isAtBottom();
                const messageContent = lastBotBubble.querySelector('.message-content') || document.createElement('div');
                messageContent.className = 'message-content';
                
                // Use debounced parsing for better performance
                debouncedParse(streamingBuffer, (parsedHTML) => {
                    // Use requestAnimationFrame to avoid blocking
                    requestAnimationFrame(() => {
                        messageContent.innerHTML = parsedHTML;
                        
                        // Add streaming cursor
                        const cursorElement = document.createElement('span');
                        cursorElement.className = 'streaming-cursor';
                        messageContent.appendChild(cursorElement);
                        
                        // Batch DOM operations
                        if (lastBotBubble.querySelector('.message-content')) {
                            lastBotBubble.querySelector('.message-content').replaceWith(messageContent);
                        } else {
                            lastBotBubble.innerHTML = '';
                            lastBotBubble.appendChild(messageContent);
                        }
                        
                        // Defer non-critical operations
                        setTimeout(() => {
                            safeRenderMath(messageContent);  // Use your safe function
                            applyPostProcessing(messageContent);
                        }, 50);
                        
                        // Add button container if it doesn't exist
                        let buttonContainer = lastBotBubble.querySelector('.message-buttons');
                        if (!buttonContainer) {
                            buttonContainer = document.createElement('div');
                            buttonContainer.className = 'message-buttons';
                            buttonContainer.innerHTML = `
                                <div class="action-buttons h-8 mt-0.5 flex flex-row flex-wrap w-full justify-between last-response print:hidden">
                                <div class="flex items-center w-max rounded-lg text-xs start-0 md:start-3 -ml-4 -mt-2 opacity-100 p-0 gap-0" style="bottom: 120px;">
                                <button class="copy-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Copy" data-state="closed"><span style="opacity: 1; transform: none;">
                                        ${CopyIcon}</span>
                                </button>
                                <button class="like-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Like" id="radix-«r1oc»" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span style="opacity: 1; transform: none;">
                                    ${Like}</span>
                                </button>
                                <button class="dislike-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Dislike" id="radix-«r1oi»" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span style="opacity: 1; transform: none;">
                                    ${Dislike}</span>
                                </button>
                                <div class="tooltip">
                                    <button class="regen-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60" type="button" aria-label="Regenerate" data-state="closed"><span style="opacity: 1; transform: none;">
                                        ${ReGen}</span>
                                        </button>
                                    <span class="tooltip-text">Regerate</span>
                                </div>
                                <button class="export-pdf-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium leading-[normal] cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed transition-colors duration-100 [&amp;_svg]:shrink-0 select-none text-fg-secondary hover:text-fg-primary hover:bg-button-ghost-hover disabled:hover:text-fg-secondary disabled:hover:bg-transparent [&amp;_svg]:hover:text-fg-primary h-10 w-10 rounded-full opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 [.last-response_&amp;]:opacity-100 disabled:opacity-0 group-focus-within:disabled:opacity-60 group-hover:disabled:opacity-60 [.last-response_&amp;]:disabled:opacity-60 relative" type="button" aria-label="Start thread" data-state="closed"><span style="opacity: 1; transform: none;">
                                        ${ExpIco}</span>
                                </button>
                                
                                    </div>
                                </div>
                            `;
                            lastBotBubble.appendChild(buttonContainer);
                            
                            const likeBtn = buttonContainer.querySelector('.like-btn');
                            const dislikeBtn = buttonContainer.querySelector('.dislike-btn');
                            const copyBtn = buttonContainer.querySelector('.copy-btn');
                            const exportBtn = buttonContainer.querySelector('.export-pdf-btn');
                            likeBtn.onclick = () => handleFeedback(lastBotBubble, 'like');
                            dislikeBtn.onclick = () => handleFeedback(lastBotBubble, 'dislike');
                            copyBtn.onclick = () => copyMessage(lastBotBubble);
                            exportBtn.onclick = () => exportToPDF(lastBotBubble, streamingBuffer);
                        }
                        
                        if (wasAtBottom) {
                            scrollToBottom();
                        }
                    });
                });
            }
        }

        function applyPostProcessing(element) {
            element.querySelectorAll('pre code').forEach(codeElem => {
                hljs.highlightElement(codeElem);
                const pre = codeElem.parentElement;
                if (!pre.parentElement.classList.contains('code-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-wrapper';
                    wrapper.title = 'Click to open in editor';
                    wrapper.style.cursor = 'pointer';
                    const clone = pre.cloneNode(true);
                    wrapper.appendChild(clone);
                    pre.replaceWith(wrapper);
                    wrapper.onclick = () => openCanvas(clone.innerText, codeElem.className);
                }
            });
        }

        
        function updateSidebarActiveState() {
            const allChatItems = document.querySelectorAll('.chat-list-item');
            allChatItems.forEach(item => {
                item.classList.toggle('active', item.dataset.chatId == activeChatId);
            });
        }
        
        // --- MONACO EDITOR CANVAS ---
        let canvasOpen = false;

        function getLanguageFromFilename(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const map = {
                js: 'javascript', py: 'python', html: 'html', css: 'css',
                ts: 'typescript', java: 'java', cs: 'csharp', json: 'json',
                md: 'markdown', yaml: 'yaml', sql: 'sql', sh: 'shell'
            };
            return map[extension] || 'plaintext';
        }
    

        function extractLanguage(text) {
            // Check if the input is a string and not empty
            if (typeof text !== 'string' || text.trim() === '') {
                console.error("Invalid input: Please provide a non-empty string.");
                return null;
            }
        
            // Split the string by the hyphen
            const parts = text.split('-');
        
            // Check if the string has at least two parts and starts with "language"
            if (parts.length >= 2 && parts[0] === 'language') {
                // The language part is the second element (index 1)
                // We also need to remove any trailing " hljs" if present
                const languagePart = parts[1];
                const hljsIndex = languagePart.indexOf(' hljs');
                if (hljsIndex !== -1) {
                    return languagePart.substring(0, hljsIndex);
                }
                return languagePart;
            } else {
                // Fallback for simple language names
                const hljsIndex = text.indexOf(' hljs');
                if (hljsIndex !== -1) {
                    return text.substring(0, hljsIndex);
                }
                return text;
            }
        }
        
        // You'll need to expand this map for file extensions
        const languageExtensionMap = {
            'javascript': 'js',
            'python': 'py',
            'html': 'html',
            'css': 'css',
            'yaml': 'yaml',
            'json': 'json',
            'typescript': 'ts',
            'java': 'java',
            'csharp': 'cs'
        };
        
        function getFileExtension(language) {
            return languageExtensionMap[language] || 'txt';
        }
        
        
        
        function openCanvas(codeText, nameOrClass) {
            closeHistoryPanel();
            
            if (monacoEditor) { 
                monacoEditor.dispose();
                monacoEditor = null;
            }
        
            const panel = document.getElementById('canvas-panel');
            panel.innerHTML = `
                    <div id="canvas-header">
                        <div class="tooltip"><button id="btn-undo"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M12.5 8C9.85 8 7.45 8.97 5.6 10.6L2 7V16H11L7.38 12.38C8.77 11.22 10.54 10.5 12.5 10.5C16.04 10.5 19.05 12.81 20.1 16L22.47 15.22C21.08 11.03 17.15 8 12.5 8Z" fill="currentColor"/></svg></button><span class="tooltip-text">Undo</span></div>
                        <div class="tooltip"><button id="btn-redo"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M11.5 8C14.15 8 16.55 8.97 18.4 10.6L22 7V16H13L16.62 12.38C15.23 11.22 13.46 10.5 11.5 10.5C7.96 10.5 4.95 12.81 3.9 16L1.53 15.22C2.92 11.03 6.85 8 11.5 8Z" fill="currentColor"/></svg></button><span class="tooltip-text">Redo</span></div>
                        <div class="tooltip"><button id="btn-copy"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"/></svg></button><span class="tooltip-text">Copy</span></div>
                        <div class="tooltip"><button id="btn-save"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M7.70711 10.2929C7.31658 9.90237 6.68342 9.90237 6.29289 10.2929C5.90237 10.6834 5.90237 11.3166 6.29289 11.7071L11.2929 16.7071C12.68342 17.0976 12.3166 17.0976 12.7071 16.7071L17.7071 11.7071C18.0976 11.3166 18.0976 10.6834 17.7071 10.2929C17.3166 9.90237 16.6834 9.90237 16.2929 10.2929L13 13.5858L13 4C13 3.44771 12.5523 3 12 3C11.4477 3 11 3.44771 11 4L11 13.5858L7.70711 10.2929Z" fill="currentColor"/><path d="M5 19C4.44772 19 4 19.4477 4 20C4 20.5523 4.44772 21 5 21H19C19.5523 21 20 20.5523 20 20C20 19.4477 19.5523 19 19 19L5 19Z" fill="currentColor"/></svg></button><span class="tooltip-text">Save File</span></div>
                        <div id="preview-button-container" class="tooltip" style="display: none;"><button id="btn-preview"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/></svg></button><span class="tooltip-text">Preview</span></div>
                        <div id="run-button-container" class="tooltip" style="display: none;"><button id="btn-run"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M8 5V19L19 12L8 5Z" fill="currentColor"/></svg></button><span class="tooltip-text">Run</span></div>
                        <div class="tooltip" style="margin-left: auto;"><span id="canvas-close"><svg width="22" height="22" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M195.2 195.2a64 64 0 0 1 90.496 0L512 421.504 738.304 195.2a64 64 0 0 1 90.496 90.496L602.496 512 828.8 738.304a64 64 0 0 1-90.496 90.496L512 602.496 285.696 828.8a64 64 0 0 1-90.496-90.496L421.504 512 195.2 285.696a64 64 0 0 1 0-90.496z"/></svg></span><span class="tooltip-text">Close</span></div>
                    </div>
                    <div id="canvas-content" style="height: calc(100% - 40px - 150px - 50px); width: 100%;">
                        <div class="spinner-code"></div>
                    </div>
                    <div id="canvas-output"></div>
                    <div id="canvas-chat-area"><div id="chat-toggle-icon"><svg class="chat-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M9 7L10 0H8L2 7V9H7L6 16H8L14 9L14 7H9Z"/>
                </svg>
            </div><div class="input-container">
                <textarea id="canvas-chat-input" placeholder="Ask AI..." rows="1"></textarea></div> <button id="canvas-chat-send">
                <svg class="send-icon" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z"/></svg>
                </button>
                </div>
                    `;
        
            panel.classList.add('open');
            canvasOpen = true;
        
            // --- THEME SYNC HELPERS (Monaco + optional hljs) ---
            // These are intentionally small and scoped to the panel instance to avoid global pollution.
            function getPreferredMonacoTheme() {
              return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'vs-dark' : 'vs';
            }
        
            function setHLJSCdnLinkForTheme(isDark) {
              // If the page uses a <link id="hljs-theme"> (as you showed earlier),
              // swap to the matching CDN file. If not present, do nothing.
              try {
                const link = document.getElementById('hljs-theme');
                if (!link) return;
                const light = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css';
                const dark = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css';
                link.href = isDark ? dark : light;
              } catch (e) {
                // don't break if something unexpected happens
                console.warn('HLJS theme switch failed', e);
              }
            }
        
            function applyMonacoTheme(theme) {
              try {
                if (window.monaco && window.monaco.editor) {
                  window.monaco.editor.setTheme(theme);
                }
              } catch (e) {
                // ignore if monaco not ready
              }
            }
        
            // Attach a matchMedia listener and keep references on panel for cleanup
            (function setupThemeWatcher() {
              if (!window.matchMedia) return;
              const mq = window.matchMedia('(prefers-color-scheme: dark)');
              // initial apply
              const initialIsDark = mq.matches;
              const initialTheme = initialIsDark ? 'vs-dark' : 'vs';
              // apply HLJS (optional) and attempt to apply Monaco (if available later)
              setHLJSCdnLinkForTheme(initialIsDark);
              applyMonacoTheme(initialTheme);
        
              // listener
              const listener = (e) => {
                const isDark = !!e.matches;
                const themeName = isDark ? 'vs-dark' : 'vs';
                setHLJSCdnLinkForTheme(isDark);
                applyMonacoTheme(themeName);
              };
        
              // use modern addEventListener where available
              if (mq.addEventListener) mq.addEventListener('change', listener);
              else if (mq.addListener) mq.addListener(listener);
        
              // store for cleanup when panel closes
              panel.__themeWatcher = { mq, listener };
            })();
            // --- end theme helpers ---
        
        
            // --- FIX FOR SYNTAX HIGHLIGHTING ---
            window.MonacoEnvironment = {
                getWorkerUrl: function (moduleId, label) {
                    return `https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.worker.js`;
                }
            };
        
        
            // Load Monaco dynamically without require.js conflicts
            if (!window.monaco) {
                const loaderScript = document.createElement('script');
                loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js';
                loaderScript.onload = () => {
                    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
                    require(['vs/editor/editor.main'], () => initializeMonacoEditor(codeText, nameOrClass));
                };
                document.head.appendChild(loaderScript);
            } else {
                initializeMonacoEditor(codeText, nameOrClass);
            }
        
            function initializeMonacoEditor(codeText, nameOrClass) {
                const editorContainer = document.getElementById('canvas-content');
                if (!editorContainer) return;
                editorContainer.innerHTML = '';
                editorContainer.style.display = 'block';
        
                // Determine language: if it looks like a class (language-python), parse it. Otherwise, treat as filename.
                let detectedLanguage;
                if (nameOrClass.startsWith('language-')) {
                     detectedLanguage = nameOrClass.replace('language-', '').split(' ')[0];
                } else {
                     detectedLanguage = getLanguageFromFilename(nameOrClass);
                }
        
                setupLanguageProviders(detectedLanguage);
        
                const editorOptions = {
                    value: codeText,
                    language: detectedLanguage,
                    theme: 'vs-light',
                    automaticLayout: true,
                    fontSize: 14,
                    fontFamily: 'Fira Code, Consolas, "Courier New", monospace',
                    wordWrap: 'off',
                    scrollBeyondLastLine: false,
                    minimap: { enabled: true },
                    suggestOnTriggerCharacters: true,
                    acceptSuggestionOnEnter: 'on',
                    wordBasedSuggestions: 'matchingDocuments',
                    quickSuggestions: {
                        other: true,
                        comments: false,
                        strings: false
                    },
                    parameterHints: {
                        enabled: true
                    }
                };
                
                // Check if it's a mobile device and adjust the options
                if (isMobileDevice()) {
                   
                    editorOptions.fontSize = 14; 
                    editorOptions.minimap.enabled = false; 
                    editorOptions.wordWrap = 'off'; 
                    editorOptions.scrollBeyondLastLine = false;
                    editorOptions.fontFamily= 'monospace',
                    editorOptions.quickSuggestions = { 
                        other: true,
                        comments: false,
                        strings: false
                    };
                    // You could also turn off other features like parameter hints if they clutter the UI
                    editorOptions.parameterHints.enabled = false;
                }
        
                monacoEditor = monaco.editor.create(editorContainer, editorOptions);
        
                // After creating the editor, ensure the correct theme is applied (in case it wasn't ready earlier)
                try {
                  const themeName = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'vs-dark' : 'vs';
                  applyMonacoTheme(themeName);
                } catch (e) {
                  // not fatal
                }
        
                // Conditionally display the preview and run buttons
        
                const toggleIcon = panel.querySelector('#chat-toggle-icon');
                const chatInput =  panel.querySelector('#canvas-chat-input');
                const chatArea =   panel.querySelector('#canvas-chat-area');
                const sendButton = panel.querySelector('#canvas-chat-send');
        
                toggleIcon.addEventListener('click', (event) => {
                    event.stopPropagation();
                    toggleChat();
                });
            
                // Also allow clicking the main area when collapsed
                chatArea.addEventListener('click', (event) => {
                    if (!chatArea.classList.contains('expanded')) {
                        event.stopPropagation();
                        toggleChat();
                    }
                });
            
                function toggleChat() {
                    chatArea.classList.toggle('expanded');
                    
                    // Focus the input field when expanded
                    if (chatArea.classList.contains('expanded')) {
                        setTimeout(() => {
                            chatInput.focus();
                        }, 200); // Small delay to ensure animation is in progress
                    }
                }
            
                // Close the widget if user clicks outside of it
                document.addEventListener('click', (event) => {
                    if (!chatArea.contains(event.target) && chatArea.classList.contains('expanded')) {
                        chatArea.classList.remove('expanded');
                    }
                });
            
        
            
                // Handle Enter key in textarea
                chatInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendButton.click();
                    }
                });
            
                // Auto-resize textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

        
                const previewButtonContainer = panel.querySelector('#preview-button-container');
                const runButtonContainer = panel.querySelector('#run-button-container');
                
                if (detectedLanguage === 'html') {
                    previewButtonContainer.style.display = 'block';
                } else {
                    previewButtonContainer.style.display = 'none';
                }
        
                if (detectedLanguage === 'python') { // Only for Python for now
                    runButtonContainer.style.display = 'block';
                    // Adjust canvas-content height to make space for output
                    panel.querySelector('#canvas-content').style.height = 'calc(100% - 40px - 150px)'; // Header + Output
                } else {
                    runButtonContainer.style.display = 'none';
                    panel.querySelector('#canvas-content').style.height = 'calc(100% - 40px)'; // Only Header
                    panel.querySelector('#canvas-output').classList.remove('has-output', 'error');
                    panel.querySelector('#canvas-output').textContent = ''; // Clear previous output
                }
        
                // If Monaco editor is created, ensure layout is updated on panel resize
                // This is important when run button appears/disappears and changes layout
                monacoEditor.layout();
            }
        
            // Event listeners for buttons (same as before)
            panel.querySelector('#btn-undo').onclick = () => monacoEditor?.trigger('source', 'undo');
            panel.querySelector('#btn-redo').onclick = () => monacoEditor?.trigger('source', 'redo');
        
            panel.querySelector('#btn-copy').onclick = () => {
                const code = monacoEditor?.getValue() || '';
                // Use document.execCommand for broader compatibility in iframes
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Copied');
                } catch (err) {
                    console.error('Failed to copy code: ', err);
                    showNotification('Copy Failed');
                }
                document.body.removeChild(textArea);
            };
        
            panel.querySelector('#btn-save').onclick = async () => {
                const code = monacoEditor?.getValue() || '';
                // If the file is already saved, use its name. Otherwise, prompt.
                let filename = currentOpenFile.filename || prompt("Enter a filename (e.g., script.py):");
                
                if (filename) {
                    try {
                        const res = await fetch('/code-files', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ filename, code })
                        });
                        if (res.ok) {
                            showNotification('File saved');
                            
                            const newFile = await res.json();
                            currentOpenFile = { id: newFile.id, filename: newFile.filename }; // Update current file state
                        } else {
                            throw new Error('Failed to save file.');
                        }
                    } catch (error) {
                        console.error("Save failed:", error);
                        showNotification('Save Failed');
                    }
                }
            };
        
            panel.querySelector('#canvas-chat-send').onclick = async () => {

                const chatInput =  panel.querySelector('#canvas-chat-input');
                chatInput.style.height = '40px';  
                const prompt = document.getElementById('canvas-chat-input').value;
                const code = monacoEditor?.getValue() || '';
                if (!prompt) return;
        
                document.getElementById('canvas-chat-input').value = '';
                showNotification('AI is thinking...');
        
                if (monacoEditor) {
                    monacoEditor.setValue('');
                }
        
                try {
                    const response = await fetch('/canvas-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, code })
                    });
        
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
        
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    // Get the user's current selection. This range will be updated after each chunk
                    // to ensure the next chunk appends correctly.
                    let editRange = monacoEditor.getSelection();
                    
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n\n');
        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const data = JSON.parse(line.substring(5));
        
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                
                                // The `executeEdits` callback gives us the range of the newly inserted text.
                                monacoEditor.executeEdits(
                                    'ai-agent',
                                    [{ range: editRange, text: data, forceMoveMarkers: true }],
                                    (inverseEditOps) => {
                                        if (inverseEditOps && inverseEditOps.length > 0) {
                                            const newRange = inverseEditOps[0].range;
                                            editRange = new monaco.Selection(
                                                newRange.endLineNumber,
                                                newRange.endColumn,
                                                newRange.endLineNumber,
                                                newRange.endColumn
                                            );
                                        }
                                        return null; // We don't need to change the final selection.
                                    }
                                );
                            }
                        }
                    }
                    showNotification('AI edit complete');
                } catch (error) {
                    console.error('Canvas chat error:', error);
                    showNotification('AI chat failed');
                }
            };
        
            
        
            panel.querySelector('#canvas-close').onclick = () => {
                panel.classList.remove('open');
                canvasOpen = false;
                currentOpenFile = { id: null, filename: null }; // Reset current file
                if (monacoEditor) {
                    monacoEditor.dispose();
                    monacoEditor = null;
                }
                const canvasOutput = panel.querySelector('#canvas-output');
                canvasOutput.textContent = '';
                canvasOutput.classList.remove('has-output', 'error');
        
                // CLEANUP: remove matchMedia listener for theme changes if we attached one
                try {
                  if (panel.__themeWatcher) {
                    const { mq, listener } = panel.__themeWatcher;
                    if (mq) {
                      if (mq.removeEventListener) mq.removeEventListener('change', listener);
                      else if (mq.removeListener) mq.removeListener(listener);
                    }
                    delete panel.__themeWatcher;
                  }
                } catch (e) {
                  // don't let cleanup errors break closing
                  console.warn('Failed to cleanup theme watcher', e);
                }
            };
        
        
        
            // --- Existing Preview Feature Logic ---
            const previewBtn = panel.querySelector('#btn-preview');
            const fullScreenPreviewModal = document.getElementById('full-screen-preview-modal');
            const previewIframe = document.getElementById('preview-iframe');
            const mobileViewBtn = document.getElementById('mobile-view-btn');
            const desktopViewBtn = document.getElementById('desktop-view-btn');
            const closePreviewBtn = document.getElementById('close-preview');
        
            if (previewBtn) {
                previewBtn.onclick = () => {
                    const htmlCode = monacoEditor?.getValue() || '';
                    previewIframe.srcdoc = htmlCode;
                    fullScreenPreviewModal.style.display = 'flex';
                    previewIframe.classList.remove('mobile-view');
                    previewIframe.classList.add('desktop-view');
                };
            }
        
            if (mobileViewBtn) {
                mobileViewBtn.onclick = () => {
                    previewIframe.classList.remove('desktop-view');
                    previewIframe.classList.add('mobile-view');
                    mobileViewBtn.classList.add('isactive');
                    desktopViewBtn.classList.remove('isactive');
                };
            }
        
            if (desktopViewBtn) {
                desktopViewBtn.onclick = () => {
                    previewIframe.classList.remove('mobile-view');
                    previewIframe.classList.add('desktop-view');
                    desktopViewBtn.classList.add('isactive');
                    mobileViewBtn.classList.remove('isactive');
        
                };
            }
        
            if (closePreviewBtn) {
                closePreviewBtn.onclick = () => {
                    fullScreenPreviewModal.style.display = 'none';
                    previewIframe.srcdoc = '';
                };
            }
        
            // --- New Run Button Logic ---
            const runBtn = panel.querySelector('#btn-run');
            const canvasOutput = panel.querySelector('#canvas-output');
        
            if (runBtn) {
                runBtn.onclick = async () => {
                    const code = monacoEditor?.getValue() || '';
                    const lang = extractLanguage(nameOrClass); // Get the actual language (e.g., 'python')
        
                    canvasOutput.textContent = 'Running code...';
                    canvasOutput.classList.add('has-output');
                    canvasOutput.classList.remove('error'); // Clear previous error state
        
                    try {
                        const response = await fetch('/run_code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: code, language: lang })
                        });
        
                        const result = await response.json();
        
                        if (result.status === 'success') {
                            canvasOutput.textContent = result.output;
                            canvasOutput.classList.remove('error');
                        } else {
                            canvasOutput.textContent = `Error:\n${result.error || result.output || 'Unknown error'}`;
                            canvasOutput.classList.add('error');
                        }
                    } catch (error) {
                        canvasOutput.textContent = `Network or internal error: ${error.message}`;
                        canvasOutput.classList.add('error');
                    }
                };
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            const filesModal = document.getElementById('files-modal');
            const closeFilesBtn = document.getElementById('close-files-modal-btn');
            const loadingFilesGlobal = document.getElementById('loading-files-global');
            const noFilesMsg = document.getElementById('no-files-msg');
            const filesGrid = document.getElementById('files-grid');
        
            function openFilesModal() {
                if (filesModal) {
                    filesModal.style.display = 'flex';
                    filesModal.setAttribute('aria-hidden', 'false');
                    if (loadingFilesGlobal) loadingFilesGlobal.style.display = 'flex';
                    if (noFilesMsg) noFilesMsg.hidden = true;
                    if (filesGrid) filesGrid.innerHTML = '';
                }
            }
        
            function closeFilesModal() {
                if (filesModal) {
                    filesModal.style.display = 'none';
                    filesModal.setAttribute('aria-hidden', 'true');
                }
            }
        
            if (filesModal) {
                filesModal.addEventListener('click', (ev) => {
                    if (ev.target === filesModal) closeFilesModal();
                });
            }
        
            if (closeFilesBtn) closeFilesBtn.addEventListener('click', closeFilesModal);
        
            document.addEventListener('keydown', (ev) => {
                if (ev.key === 'Escape' && filesModal && filesModal.style.display === 'flex') {
                    closeFilesModal();
                }
            });
        
            async function fetchAndRenderFiles() {
                try {
                    const res = await fetch('/code-files');
                    if (!res.ok) throw new Error(`Server returned ${res.status}`);
                    const files = await res.json();
                    
                    if (loadingFilesGlobal) loadingFilesGlobal.style.display = 'none';
                    
                    if (!files || files.length === 0) {
                        if (noFilesMsg) noFilesMsg.hidden = false;
                        return;
                    }
        
                    if (filesGrid) {
                        filesGrid.innerHTML = '';
                        filesGrid.style.display = 'grid';
                    }
        
                    files.forEach(file => {
                        const card = document.createElement('div');
                        card.className = 'code-card'; 
                        card.style.cursor = 'pointer';
                        
                        const fileIcon = document.createElement('div');
                        fileIcon.className = 'code-thumb';
                        fileIcon.style.display = 'flex';
                        fileIcon.style.alignItems = 'center';
                        fileIcon.style.justifyContent = 'center';
                        fileIcon.style.fontSize = '48px';
                        fileIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2.26953V6.40007C14 6.96012 14 7.24015 14.109 7.45406C14.2049 7.64222 14.3578 7.7952 14.546 7.89108C14.7599 8.00007 15.0399 8.00007 15.6 8.00007H19.7305M14 17.5L16.5 15L14 12.5M10 12.5L7.5 15L10 17.5M20 9.98822V17.2C20 18.8802 20 19.7202 19.673 20.362C19.3854 20.9265 18.9265 21.3854 18.362 21.673C17.7202 22 16.8802 22 15.2 22H8.8C7.11984 22 6.27976 22 5.63803 21.673C5.07354 21.3854 4.6146 20.9265 4.32698 20.362C4 19.7202 4 18.8802 4 17.2V6.8C4 5.11984 4 4.27976 4.32698 3.63803C4.6146 3.07354 5.07354 2.6146 5.63803 2.32698C6.27976 2 7.11984 2 8.8 2H12.0118C12.7455 2 13.1124 2 13.4577 2.08289C13.7638 2.15638 14.0564 2.27759 14.3249 2.44208C14.6276 2.6276 14.887 2.88703 15.4059 3.40589L18.5941 6.59411C19.113 7.11297 19.3724 7.3724 19.5579 7.67515C19.7224 7.94356 19.8436 8.2362 19.9171 8.5423C20 8.88757 20 9.25445 20 9.98822Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        
                        const filename = document.createElement('p');
                        filename.className = 'code-title';
                        filename.textContent = file.filename;
                        filename.style.fontWeight = '600';
                        
                        card.appendChild(fileIcon);
                        card.appendChild(filename);
                        
                        card.onclick = () => {
                            openCanvas(file.code, file.filename);
                            currentOpenFile = { id: file.id, filename: file.filename };
                            closeFilesModal();
                        };
                        
                        if (filesGrid) filesGrid.appendChild(card);
                    });
        
                } catch (err) {
                    if (loadingFilesGlobal) loadingFilesGlobal.style.display = 'none';
                    if (noFilesMsg) {
                        noFilesMsg.hidden = false;
                        noFilesMsg.textContent = 'Error loading files. Please try again.';
                    }
                    console.error('Error fetching files:', err);
                }
            }
        
            // Open modal button delegation
            document.addEventListener('click', function(event) {
                const btn = event.target.closest && event.target.closest('#view-files-btn');
                if (btn) {
                    openFilesModal();
                    fetchAndRenderFiles();
                }
            });
        });
        
        

        const recommendations = ['help me', 'Generate React component', 'Write unit tests', 'Optimize CSS layout'];
        const mobileRecommendations = ['help me', 'Analyse docs', 'Unit tests', 'Latest News'];

        function renderMainChatView(){
            chatContainer.innerHTML = `<div class="nex-head"><svg class="transition-all tect-[#c1c1c1] duration-200 active:scale-95 active:opacity-70" width="35" height="35" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 7L10 0H8L2 7V9H7L6 16H8L14 9L14 7H9Z" fill="currentColor"></path></svg><span>Nexora</span></div>`
        }

        function renderRecommendations() {
            // Hide spinner when showing recommendations
            if (chatContainerSpinner.parentNode === chatContainer) {
                chatContainerSpinner.style.display = 'none';
            }
            
            recContainer.innerHTML = '';
        
            const currentRecommendations = isMobileDevice() ? mobileRecommendations : recommendations;
        
            currentRecommendations.forEach(text => {
                const block = document.createElement('div');
                block.className = 'rec-block';
                block.textContent = text;
                block.onclick = () => {
                    input.value = text;
                    autoResize();
                    input.focus();
                };
                recContainer.appendChild(block);
            });
            chatContainer.appendChild(recContainer);
        }
        
        function clearRecommendations() {
            if (recContainer && recContainer.parentNode) {
                recContainer.classList.remove('hidden');
                recContainer.parentNode.removeChild(recContainer);
            }
            recContainer.innerHTML = '';

            const nexHead = chatContainer.querySelector('.nex-head');
            if (nexHead) nexHead.remove();
        }
        function autoResize() {
            input.style.height = 'auto';
            input.style.height = (input.scrollHeight) + 'px';
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHistoryPanel();
            sendBtn.onclick = sendMessage;
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            const newChatBtnHeader=document.querySelector(".new-ch-tog");
            newChatBtnHeader.onclick = createNewChat;
          

            input.addEventListener('input', () => {
                autoResize();
                handleRecommendationVisibility();
            });

            input.addEventListener('focus', handleRecommendationVisibility);
            input.addEventListener('blur', handleRecommendationVisibility);
        
            scrollableContainer.addEventListener('scroll', () => {
                // Use requestAnimationFrame for better performance on mobile
                requestAnimationFrame(() => {
                    const threshold = 10; // Add a small threshold for mobile touch scrolling
                    const isNearBottom = scrollableContainer.scrollTop + scrollableContainer.clientHeight >= 
                                       scrollableContainer.scrollHeight - threshold;
                    
                    if (isNearBottom) {
                        scrollToBottomBtn.style.display = 'none';
                    } else {
                        scrollToBottomBtn.style.display = 'flex';
                    }
                });
            });
        
            scrollToBottomBtn.onclick = scrollToBottom;

            let touchStartY = 0;
            let touchEndY = 0;
            
            scrollableContainer.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            scrollableContainer.addEventListener('touchend', (e) => {
                touchEndY = e.changedTouches[0].clientY;
                // Check scroll position after touch ends
                setTimeout(checkScrollButtonVisibility, 100);
            }, { passive: true });

            
        });

    
        // --- RENAME AND DELETE MODALS/FUNCTIONS ---
        function showRenameModal(chatId, currentName, callback) {
            closeHistoryPanel();
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Rename Chat</h2>
                    <input type="text" id="renameInput" value="${currentName}" placeholder="Enter new chat name">
                    <div class="modal-buttons">
                        <button id="confirmRename">Save</button>
                        <button id="cancelRename">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
    
            document.getElementById('confirmRename').addEventListener('click', () => {
                const newName = document.getElementById('renameInput').value.trim();
                if (newName) {
                    callback(newName);
                    modal.remove();
                }
            });
    
            document.getElementById('cancelRename').addEventListener('click', () => {
                modal.remove();
            });
        }
    
        function showDeleteModal(chatId, callback) {
            const modal = document.createElement('div');
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Delete Chat</h2>
                    <p>Are you sure you want to delete this chat?</p>
                    <div class="modal-buttons">
                        <button id="confirmDelete">Delete</button>
                        <button id="cancelDelete">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
    
            document.getElementById('confirmDelete').addEventListener('click', () => {
                callback();
                modal.remove();
            });
    
            document.getElementById('cancelDelete').addEventListener('click', () => {
                modal.remove();
            });
        }
    
        window.renameChat = async function(chatId) {
            const chatItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
            const currentName = chatItem ? chatItem.querySelector('.chat-list-title').textContent : '';
            showRenameModal(chatId, currentName, async (newTitle) => {
                await fetch(`/chats/${chatId}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle })
                });
                loadHistoryPanel();
            });
        }
        
        window.deleteChat = async function(chatId) {
            showDeleteModal(chatId, async () => {
                await fetch(`/chats/${chatId}`, { method: 'DELETE' });
                if (chatId == activeChatId) {
                    activeChatId = null;
                    createNewChat(); // Go to new chat view
                    loadHistoryPanel();

                }

            });
        }
    
        function toggleMenu(chatId) {
            // Close all other menus first
            document.querySelectorAll('.chat-menu').forEach(menu => {
                if (menu.dataset.chatId != chatId) {
                    menu.style.display = 'none';
                }
            });
            
            // Toggle the target menu
            const targetMenu = document.querySelector(`.chat-menu[data-chat-id="${chatId}"]`);
            if (targetMenu) {
                targetMenu.style.display = targetMenu.style.display === 'block' ? 'none' : 'block';
            }
    
            const closeMenu = (e) => {
                if (!e.target.closest('.chat-menu-wrapper') && !e.target.closest('.custom-modal')) {
                    document.querySelectorAll('.chat-menu').forEach(menu => menu.style.display = 'none');
                    document.removeEventListener('click', closeMenu, true);
                }
            };
            // Use capture phase to handle clicks properly
            document.addEventListener('click', closeMenu, true);
        }

        function handleFeedback(bubble, type) {
            // Toggle active state
            const btn = bubble.querySelector(`.${type}-btn`);
            const otherBtn = bubble.querySelector(type === 'like' ? '.dislike-btn' : '.like-btn');
            btn.classList.toggle('active');
            otherBtn.classList.remove('active');
            // Optional: Send feedback to server
            fetch('/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: activeChatId, message: bubble.textContent, feedback: type })
            }).catch(error => console.error('Failed to send feedback:', error));
        }
     
        // Create the custom notification div once (this should be done outside the copy function, e.g., on page load after DOM is ready)
        

// Updated copyMessage function using the custom div
        function copyMessage(bubble) {
            const text = bubble.querySelector('.message-content').textContent;
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Copied');
                } else {
                    throw new Error('Copy command failed');
                }
            } catch (err) {
                console.error('Failed to copy message:', err);
                // Modern fallback: use navigator.clipboard if available
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('Copied');
                    }).catch(err2 => {
                        console.error('Clipboard API failed:', err2);
                        showNotification('Copy failed. Please select and copy manually.');
                    });
                } else {
                    showNotification('Copy failed. Please select and copy manually.');
                }
            } finally {
                document.body.removeChild(textArea);
            }
        }

// Example usage:
// Assuming you have a bubble element: copyMessage(yourBubbleElement);
     
async function exportToPDF(bubble, text) {
    try {
        showNotification("Exporting..");

        // Validate input
        if (!text) {
            throw new Error("Content is empty");
        }

        // Create a form element
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/export_pdf';
        form.target = '_blank'; // Open in new tab
        form.style.display = 'none'; // Hide the form

        // Create JSON payload
        const payload = JSON.stringify({
            content: text,
            chat_id: activeChatId || 'new'
        });

        // Add JSON payload as a hidden input
        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'data'; // Match server endpoint's expected field
        dataInput.value = payload;
        form.appendChild(dataInput);

        // Append form to body and submit
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        showNotification("Exported..");
    } catch (error) {
        console.error('Failed to export PDF:', {
            message: error.message,
            stack: error.stack,
            inputContent: text?.substring(0, 100) + (text?.length > 100 ? '...' : ''), // Log first 100 chars
            chatId: activeChatId
        });
        const errmsg = `Export Failed: ${error.message}`;
        showNotification(errmsg);
    }
}

        let uploadedFiles = []; // Store uploaded files
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const uploadPreviewContainer = document.getElementById('upload-preview-container');
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => uploadFile(file));
            event.target.value = ''; // Reset input
        }
        const SUPABASE_URL="https://bbshgzacajotvaucavtr.supabase.co";
        const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJic2hnemFjYWpvdHZhdWNhdnRyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NDgxMDY0NCwiZXhwIjoyMDcwMzg2NjQ0fQ.Min4tBtZO-6rdV-_ak6SY42nm2z0poqXJ95t7esq-nQ";
        
        // --- Utility function for UUID (if you don't have one globally) ---
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }



    async function uploadFile(file) {
        const fileId = Date.now() + Math.random();
        const uploadItem = createUploadPreview(file, fileId);
        uploadPreviewContainer.appendChild(uploadItem);
        uploadPreviewContainer.style.display = 'block';

        try {
            // Update status to uploading
            updateUploadStatus(fileId, 'uploading', 'Uploading...');

            const bucketName = "nexora-ai"; // Your Supabase storage bucket name

            // Generate a unique filename using UUID
            const fileExtension = file.name.split('.').pop();
            const filename = `${generateUUID()}.${fileExtension}`;

            const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${bucketName}/${filename}`;

            const headers = {
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`,
                "Content-Type": file.type || "application/octet-stream" // Use file.type directly
            };

            // Directly upload the file using fetch
            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: headers,
                body: file // The File object can be directly used as the body
            });

            if (!response.ok) {
                // Supabase API might return a JSON error
                const errorText = await response.text();
                throw new Error(`Upload failed with status code ${response.status}: ${errorText}`);
            }

            // Supabase successful upload typically returns 200/201 with an empty body or a success message
            // The public URL needs to be constructed
            const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${bucketName}/${filename}`;

            // Store file info for sending with message
            uploadedFiles.push({
                id: fileId,
                filename: file.name,
                type: file.type,
                size: file.size,
                url: publicUrl,
                data: {} // Supabase direct upload doesn't return a JSON body with extra data,
                        // so we'll keep this empty or populate with what's available (url)
            });

            updateUploadStatus(fileId, 'success', 'Uploaded successfully');

        } catch (error) {
            console.error('Upload error:', error);
            updateUploadStatus(fileId, 'error', `Upload failed: ${error.message}`);
        }
    }
        
        function createUploadPreview(file, fileId) {
            const uploadItem = document.createElement('div');
            uploadItem.className = 'upload-item uploading';
            uploadItem.dataset.fileId = fileId;
        
            const preview = document.createElement('div');
            preview.className = 'upload-preview';
        
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'upload-preview';
                img.style.width = '40px';
                img.style.height = '40px';
                preview.appendChild(img);
            } else {
                const ext = file.name.split('.').pop().toUpperCase();
                preview.textContent = ext;
            }
        
            const info = document.createElement('div');
            info.className = 'upload-info';
            info.innerHTML = `
                <div class="upload-name">${file.name}</div>
                <div class="upload-status">Preparing upload...</div>
            `;
        
            const removeBtn = document.createElement('button');
            removeBtn.className = 'upload-remove';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = () => removeUploadItem(fileId);
        
            uploadItem.appendChild(preview);
            uploadItem.appendChild(info);
            uploadItem.appendChild(removeBtn);
        
            return uploadItem;
        }
        
        function updateUploadStatus(fileId, status, message) {
            const uploadItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (!uploadItem) return;
        
            const statusElement = uploadItem.querySelector('.upload-status');
            statusElement.textContent = message;
            statusElement.className = `upload-status ${status}`;
        
            uploadItem.className = `upload-item ${status}`;
        
            if (status === 'uploading') {
                const spinner = document.createElement('div');
                spinner.className = 'upload-spinner';
                statusElement.prepend(spinner);
            }
        }
        
        function removeUploadItem(fileId) {
            const uploadItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (uploadItem) {
                uploadItem.remove();
            }
            
            // Remove from uploadedFiles array
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            
            // Hide container if no files
            if (uploadedFiles.length === 0) {
                uploadPreviewContainer.style.display = 'none';
            }
        }

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          // --------------------------
          // Lightbox HTML injection
          // --------------------------
          const lightboxHtml = `
          <div id="custom-lightbox" class="custom-lightbox" hidden aria-hidden="true" role="dialog" aria-modal="true">
            <div class="clb-overlay" data-action="close" tabindex="-1"></div>
            <div class="clb-panel" role="document">
              <button class="clb-close" data-action="close" aria-label="Close (Esc)">✕</button>
              <div class="clb-stage">
                <button class="clb-nav clb-prev" data-action="prev" aria-label="Previous image">‹</button>
                <div class="clb-mediawrap">
                  <div class="clb-spinner" aria-hidden="true"></div>
                  <img class="clb-image" alt="">
                </div>
                <button class="clb-nav clb-next" data-action="next" aria-label="Next image">›</button>
              </div>
              <div class="clb-info">
                <div class="clb-caption" aria-live="polite"></div>
                <div class="clb-actions">
                  <a class="clb-download" role="button" href="#" download aria-label="Download image">Download</a>
                  <a class="clb-open" target="_blank" rel="noopener noreferrer" aria-label="Open in new tab">Open</a>
                </div>
              </div>
            </div>
          </div>
          `;
          const parser = new DOMParser();
          const doc = parser.parseFromString(lightboxHtml, 'text/html');
          const lightboxNode = doc.body.firstElementChild;
          document.body.appendChild(lightboxNode);
        
          // --------------------------
          // Elements & state
          // --------------------------
          const LB = document.getElementById('custom-lightbox');
          const overlay = LB.querySelector('.clb-overlay');
          const panel = LB.querySelector('.clb-panel');
          const imgEl = LB.querySelector('.clb-image');
          const spinner = LB.querySelector('.clb-spinner');
          const captionEl = LB.querySelector('.clb-caption');
          const downloadBtn = LB.querySelector('.clb-download');
          const openBtn = LB.querySelector('.clb-open');
          const prevBtn = LB.querySelector('.clb-prev');
          const nextBtn = LB.querySelector('.clb-next');
          const closeBtns = LB.querySelectorAll('[data-action="close"]');
          let images = []; // { src, alt, el }
          let currentIndex = 0;
          let lastActive = null;
        
          // reuse your basename util
          function basenameFromUrl(url) {
            try {
              const u = new URL(url, location.href);
              return u.pathname.split('/').pop() || u.hostname;
            } catch (e) {
              return url;
            }
          }
          function isImageUrl(url) {
            return !!url && /\.(png|jpe?g|gif|svg|webp)(\?.*)?(#.*)?$/i.test(url);
          }
        
          // --------------------------
          // Collect images from grid
          // --------------------------
          function collectImages() {
            // prefer the images in the grid rendered by your fetchAndRender
            const grid = document.getElementById('images-grid');
            if (!grid) { images = []; return; }
            images = Array.from(grid.querySelectorAll('img.thumb-img'))
              .filter(img => (img.dataset?.src || img.src) && isImageUrl(img.dataset?.src || img.src))
              .map(img => ({ src: img.dataset?.src || img.src, alt: img.alt || '', el: img }));
          }
        
          // --------------------------
          // Spinner helper
          // --------------------------
          function showSpinner(show) {
            spinner.style.display = show ? 'block' : 'none';
          }
        
          // --------------------------
          // Download logic (fetch blob -> fallback open)
          // --------------------------
          async function attemptDownload(url, filename, el) {
            try {
              if (el) el.classList.add('downloading');
              const res = await fetch(url, { mode: 'cors' });
              if (!res.ok) throw new Error('Network error');
              const blob = await res.blob();
              const blobUrl = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = blobUrl;
              a.download = filename || basenameFromUrl(url);
              document.body.appendChild(a);
              a.click();
              a.remove();
              setTimeout(() => URL.revokeObjectURL(blobUrl), 5000);
            } catch (err) {
              // fallback: open in new tab (user can save)
              window.open(url, '_blank', 'noopener');
            } finally {
              if (el) el.classList.remove('downloading');
            }
          }
        
          // --------------------------
          // Show / hide lightbox
          // --------------------------
          function updateNavVisibility() {
            prevBtn.style.display = images.length > 1 ? '' : 'none';
            nextBtn.style.display = images.length > 1 ? '' : 'none';
          }
        
          function showLightbox(index) {
            if (!images.length) return;
            currentIndex = (index + images.length) % images.length;
            const item = images[currentIndex];
            lastActive = document.activeElement;
        
            LB.hidden = false;
            LB.setAttribute('aria-hidden', 'false');
            document.documentElement.style.overflow = 'hidden'; // prevent page scroll while open
        
            imgEl.classList.remove('loaded', 'error');
            imgEl.alt = item.alt || '';
            captionEl.textContent = item.alt || basenameFromUrl(item.src);
        
            // open/download hrefs
            openBtn.href = item.src;
            downloadBtn.href = item.src;
            downloadBtn.dataset.src = item.src;
            downloadBtn.download = basenameFromUrl(item.src);
        
            // if already loaded in this imgEl
            if (imgEl.src === item.src && imgEl.complete && imgEl.naturalWidth > 0) {
              showSpinner(false);
              imgEl.classList.add('loaded');
            } else {
              showSpinner(true);
              imgEl.src = item.src;
            }
        
            // focus close for accessibility
            setTimeout(() => {
              closeBtns[0]?.focus();
            }, 50);
        
            updateNavVisibility();
          }
        
          function hideLightbox() {
            LB.hidden = true;
            LB.setAttribute('aria-hidden', 'true');
            document.documentElement.style.overflow = '';
            imgEl.src = '';
            if (lastActive && lastActive.focus) lastActive.focus();
          }
        
          // --------------------------
          // Navigation helpers
          // --------------------------
          function goNext() {
            if (!images.length) return;
            showLightbox((currentIndex + 1) % images.length);
          }
          function goPrev() {
            if (!images.length) return;
            showLightbox((currentIndex - 1 + images.length) % images.length);
          }
        
          // --------------------------
          // Image load/error events
          // --------------------------
          imgEl.addEventListener('load', () => {
            showSpinner(false);
            imgEl.classList.add('loaded');
          });
          imgEl.addEventListener('error', () => {
            showSpinner(false);
            imgEl.classList.add('error');
            captionEl.textContent = 'Failed to load image';
          });
        
          // --------------------------
          // Delegate clicks (open, nav, download, close)
          // --------------------------
          document.addEventListener('click', function (e) {
            // Thumbnail click inside the grid -> open lightbox
            const thumb = e.target.closest && e.target.closest('img.thumb-img');
            if (thumb) {
              collectImages();
              const idx = images.findIndex(i => i.el === thumb || i.src === (thumb.dataset?.src || thumb.src));
              if (idx >= 0) {
                showLightbox(idx);
              } else {
                // open single
                images = [{ src: thumb.dataset?.src || thumb.src, alt: thumb.alt || '', el: thumb }];
                showLightbox(0);
              }
              e.preventDefault();
              return;
            }
        
            // close buttons / overlay
            const closeTarget = e.target.closest && e.target.closest('[data-action="close"]');
            if (closeTarget) {
              hideLightbox();
              return;
            }
        
            // nav targets
            const navTarget = e.target.closest && e.target.closest('[data-action="next"], [data-action="prev"]');
            if (navTarget) {
              if (navTarget.dataset.action === 'next') goNext();
              else if (navTarget.dataset.action === 'prev') goPrev();
              return;
            }
        
            // download click inside lightbox
            if (e.target.closest && e.target.closest('.clb-download')) {
              e.preventDefault();
              const btn = e.target.closest('.clb-download');
              const url = btn.dataset.src || btn.href;
              const filename = btn.download || basenameFromUrl(url);
              attemptDownload(url, filename, btn);
              return;
            }
          }, false);
        
          // ---------- keyboard support ----------
          document.addEventListener('keydown', function (e) {
            if (LB.hidden || LB.getAttribute('aria-hidden') === 'true') return;
            if (e.key === 'Escape') {
              hideLightbox();
            } else if (e.key === 'ArrowRight') {
              goNext();
            } else if (e.key === 'ArrowLeft') {
              goPrev();
            }
          });
        
          // close overlay click
          LB.addEventListener('click', (e) => {
            if (e.target === overlay) hideLightbox();
          });
        
          // initial collect
          collectImages();
        
          // expose small API
          window.CustomImageLightbox = {
            open: (src) => {
              collectImages();
              const idx = images.findIndex(i => i.src === src);
              if (idx >= 0) showLightbox(idx);
              else {
                images = [{ src, alt: '', el: null }];
                showLightbox(0);
              }
            },
            refresh: collectImages
          };



        
          // --------------------------
          // === Your existing modal/grid script merged below ===
          // --------------------------
          const imagesModal = document.getElementById('images-modal');
          const closeModalBtn = document.getElementById('close-modal-btn');
          const loadingGlobal = document.getElementById('loading-global');
          const noImagesMsg = document.getElementById('no-images-msg');
          const imagesGrid = document.getElementById('images-grid');
        
          function openModal() {
            if (imagesModal) {
              imagesModal.style.display = 'flex';
              imagesModal.setAttribute('aria-hidden', 'false');
              if (loadingGlobal) loadingGlobal.style.display = 'flex';
              if (noImagesMsg) noImagesMsg.hidden = true;
              if (imagesGrid) imagesGrid.innerHTML = '';
            }
          }
          function closeModal() {
            if (imagesModal) {
              imagesModal.style.display = 'none';
              imagesModal.setAttribute('aria-hidden', 'true');
            }
          }
          if (imagesModal) {
            imagesModal.addEventListener('click', (ev) => {
              if (ev.target === imagesModal) closeModal();
            });
          }
          if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
          document.addEventListener('keydown', (ev) => {
            if (ev.key === 'Escape' && imagesModal && imagesModal.style.display === 'flex') {
              closeModal();
            }
          });
        
          const el = (tag, cls = '', attrs = {}) => {
            const e = document.createElement(tag);
            if (cls) e.className = cls;
            Object.entries(attrs).forEach(([k, v]) => e.setAttribute(k, v));
            return e;
          };
        
          // Fetch and render (keeps your existing behavior; ensures .thumb-img is present)
          async function fetchAndRender(limit = 50) {
            try {
              const resp = await fetch(`/images?limit=${encodeURIComponent(limit)}`, { cache: 'no-store' });
              if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
              const data = await resp.json();
              if (loadingGlobal) loadingGlobal.style.display = 'none';
              if (!data || !Array.isArray(data.images) || data.count === 0) {
                if (noImagesMsg) noImagesMsg.hidden = false;
                return;
              }
              if (imagesGrid) {
                imagesGrid.innerHTML = '';
                imagesGrid.style.display = 'grid';
              }
              data.images.forEach((image) => {
                const card = el('div', 'image-card');
                const thumb = el('div', 'image-thumb');
                const spinnerWrap = el('div', 'thumb-spinner');
                const spinnerEl = el('div', 'spinner');
                spinnerWrap.appendChild(spinnerEl);
                const img = el('img', 'thumb-img', { alt: image.prompt || 'Generated image', loading: 'lazy' });
                img.dataset.src = image.image_url || '';
                const prompt = el('p', 'prompt');
                prompt.textContent = image.prompt || '—';
                const date = el('p', 'date');
                const created = image.created_at ? new Date(image.created_at) : null;
                date.textContent = created && !isNaN(created) ? created.toLocaleString() : '';
                thumb.appendChild(img);
                thumb.appendChild(spinnerWrap);
                card.appendChild(thumb);
                card.appendChild(prompt);
                card.appendChild(date);
                if (imagesGrid) imagesGrid.appendChild(card);
        
                // Load handlers
                let loadHandled = false;
                function onLoad() {
                  if (loadHandled) return;
                  loadHandled = true;
                  img.classList.add('loaded');
                  if (spinnerWrap && spinnerWrap.parentNode) spinnerWrap.parentNode.removeChild(spinnerWrap);
                }
                function onError() {
                  if (loadHandled) return;
                  loadHandled = true;
                  if (spinnerWrap && spinnerWrap.parentNode) spinnerWrap.parentNode.removeChild(spinnerWrap);
                  img.src = '';
                  img.alt = 'Unable to load image';
                  img.style.background = 'repeating-linear-gradient(45deg, #f8d7da, #f1b0b7 10px)';
                  img.style.opacity = '1';
                }
                img.addEventListener('load', onLoad);
                img.addEventListener('error', onError);
        
                // Start loading (small rAF to allow spinner paint)
                requestAnimationFrame(() => {
                  if (img.dataset.src) img.src = img.dataset.src;
                });
              });
        
              // after we've appended thumbnails, refresh the lightbox collection so clicking opens
              collectImages();
        
            } catch (err) {
              if (loadingGlobal) loadingGlobal.style.display = 'none';
              if (noImagesMsg) {
                noImagesMsg.hidden = false;
                noImagesMsg.textContent = 'Error loading images. Please try again.';
              }
              console.error('Error fetching images:', err);
            }
          }
        
          // open modal button delegation
          document.addEventListener('click', function(event) {
            const btn = event.target.closest && event.target.closest('#view-images-btn');
            if (btn) {
              openModal();
              fetchAndRender(50);
            }
          });
        
          // If you need to open programmatically: window.CustomImageLightbox.open(url);
        });
        </script>

<script>
    const canvas = document.getElementById('CanavaView');
    if (!canvas) throw new Error("Canvas element with id 'CanavaView' not found");
    const ctx = canvas.getContext('2d');
    
    let particles = [];
    let w = 0, h = 0;
    let speedMultiplier = 10;
    let particleSize = 130;
    let particleOpacity = 0.1;
    let colorHue = 190;
    
    let animationId = null;
    let isAnimating = false;
    let resizeTimeout = null;
    
    // sprite cache to avoid creating gradients every frame
    const spriteCache = new Map();
    
    // Utility: create a pre-rendered circular gradient sprite
    function createSprite(size, hue, baseOpacity) {
    // round keys so cache isn't too big
    const key = `${Math.round(size)}|${Math.round(hue)}|${+baseOpacity.toFixed(2)}`;
    if (spriteCache.has(key)) return spriteCache.get(key);
    
    const s = Math.ceil(size * 2 * devicePixelRatio);
    const off = document.createElement('canvas');
    off.width = off.height = s;
    const octx = off.getContext('2d');
    
    // scale to handle DPR
    octx.scale(devicePixelRatio, devicePixelRatio);
    
    const center = size;
    const grad = octx.createRadialGradient(center, center, 0, center, center, size);
    grad.addColorStop(0, `hsla(${hue},100%,65%,${baseOpacity})`);
    grad.addColorStop(0.4, `hsla(${hue},100%,60%,${baseOpacity * 0.7})`);
    grad.addColorStop(1, `hsla(${hue},100%,55%,0)`);
    
    octx.fillStyle = grad;
    octx.beginPath();
    octx.arc(center, center, size, 0, Math.PI * 2);
    octx.fill();
    
    spriteCache.set(key, off);
    // keep cache size bounded
    if (spriteCache.size > 200) { // arbitrary limit
        // remove first entry
        const k = spriteCache.keys().next().value;
        spriteCache.delete(k);
    }
    
    return off;
    }
    
    function resizeCanvas() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    w = Math.floor(window.innerWidth);
    h = Math.floor(window.innerHeight);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // scale drawing to CSS pixels
    }
    
    // Debounced init on resize
    function handleResizeDebounced() {
    if (resizeTimeout) clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        init();
        resizeTimeout = null;
    }, 120);
    }
    
    class Particle {
    constructor() {
        this.reset();
    }
    
    reset() {
        this.x = Math.random() * w;
        this.y = Math.random() * h;
        this.targetSize = particleSize + Math.random() * 100;
        this.size = this.targetSize;
        this.baseSpeedX = (Math.random() - 0.5) * 0.5;
        this.baseSpeedY = (Math.random() - 0.5) * 0.5;
        this.baseOpacity = particleOpacity;
        this.hue = colorHue + Math.random() * 15;
        this.pulseOffset = Math.random() * Math.PI * 2;
    }
    
    update() {
        this.x += this.baseSpeedX * speedMultiplier;
        this.y += this.baseSpeedY * speedMultiplier;
    
        // wrap
        if (this.x < -this.size) this.x = w + this.size;
        if (this.x > w + this.size) this.x = -this.size;
        if (this.y < -this.size) this.y = h + this.size;
        if (this.y > h + this.size) this.y = -this.size;
    
        // small random walk
        if (Math.random() < 0.01) {
        this.baseSpeedX += (Math.random() - 0.5) * 0.1;
        this.baseSpeedY += (Math.random() - 0.5) * 0.1;
        this.baseSpeedX = Math.max(-0.8, Math.min(0.8, this.baseSpeedX));
        this.baseSpeedY = Math.max(-0.8, Math.min(0.8, this.baseSpeedY));
        }
    
        this.size += (this.targetSize - this.size) * 0.05;
        this.pulseOffset += 0.02;
    }
    
    draw() {
        const pulse = Math.sin(this.pulseOffset) * 0.15 + 1;
        const currentSize = this.size * pulse;
        const sprite = createSprite(currentSize, this.hue, this.baseOpacity);
        // drawImage handles the alpha and scaling; sprite is DPR-aware already
        ctx.drawImage(
        sprite,
        this.x - currentSize,
        this.y - currentSize,
        currentSize * 2,
        currentSize * 2
        );
    }
    }
    
    function init() {
    resizeCanvas();
    // optionally clear sprite cache if canvas size changed drastically
    // spriteCache.clear();
    
    const particleCount = 15; // keep same count; you can reduce for performance
    if (particles.length > particleCount) {
        particles.length = 0; // clear old references
    } else {
        particles = [];
    }
    for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
    }
    }
    
    function animate() {
    // one loop tick
    ctx.clearRect(0, 0, w, h);
    
    for (let i = 0; i < particles.length; i++) {
        const p = particles[i];
        p.update();
        p.draw();
    }
    
    animationId = requestAnimationFrame(animate);
    }
    
    // visibility handler: pause when hidden
    function handleVisibilityChange() {
    if (document.hidden) {
        stopAnimation();
    } else {
        startAnimation();
    }
    }
    
    // Toggle function
    function toggleAnimation() {
    if (isAnimating) stopAnimation();
    else startAnimation();
    return isAnimating;
    }
    
    function startAnimation() {
    if (isAnimating) return;
    isAnimating = true;
    if (!animationId) animationId = requestAnimationFrame(animate);
    }
    
    function stopAnimation() {
    if (!isAnimating) return;
    isAnimating = false;
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    }
    
    // Attach listeners once (but start animation only on load)
    window.addEventListener('resize', handleResizeDebounced, { passive: true });
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Clean up helper in case you remove this component
    function destroy() {
    stopAnimation();
    window.removeEventListener('resize', handleResizeDebounced);
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    if (resizeTimeout) clearTimeout(resizeTimeout);
    particles = [];
    spriteCache.clear();
    }
    
    // Start only after full page load (resources/images/fonts done)
    window.addEventListener('load', () => {
    init();
    startAnimation();
    });
            
</script>


        
<script defer src="/static/search-panel.js"></script>
<script defer src="/static/internet.js"></script>
</body>
</html>
